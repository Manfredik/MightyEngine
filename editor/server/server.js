'use strict';(function(){function O(a,b){function c(){}c.prototype=a;var d=new c,e;for(e in b)d[e]=b[e];b.toString!==Object.prototype.toString&&(d.toString=b.toString);return d}function s(a,b){if(null==b)return null;null==b.__id__&&(b.__id__=T++);var c;null==a.hx__closures__?a.hx__closures__={}:c=a.hx__closures__[b.__id__];null==c&&(c=function(){return c.method.apply(c.scope,arguments)},c.scope=a,c.method=b,a.hx__closures__[b.__id__]=c);return c}var A=function(){return v.Boot.__string_rec(this,"")},
n=function(){};n.__name__=!0;n.convertToMp3=function(a,b,c){null==b&&(b=n.getBaseName(a)+".mp3");d.debug("converting sound",a,b);d.path.resolve(a)==d.path.resolve(b)?(null!=c&&c(),d.debug("Skipped MP3")):(a="-y -i "+m.shellEscape(a)+" "+m.shellEscape(b),n.exec(a,c))};n.getErrors=function(){var a=n.errors;n.errors=[];return a};n.convertToM4a=function(a,b,c){null==b&&(b=n.getBaseName(a)+".m4a");d.path.resolve(a)==d.path.resolve(b)?null!=c&&c():(a="-y -i "+m.shellEscape(a)+" -strict -2 -vn "+m.shellEscape(b),
n.exec(a,c))};n.convertToOgg=function(a,b,c){null==b&&(b=n.getBaseName(a)+".ogg");d.path.resolve(a)==d.path.resolve(b)?null!=c&&c():(a="-y -i "+m.shellEscape(a)+" -acodec libvorbis "+m.shellEscape(b),n.exec(a,c))};n.convertToWav=function(a,b,c){null==b&&(b=n.getBaseName(a)+".wav");d.path.resolve(a)==d.path.resolve(b)?null!=c&&c():(a="-y -i "+m.shellEscape(a)+" "+m.shellEscape(b),n.exec(a,c))};n.convertToExt=function(a,b,c,f){"mp3"==b?n.convertToMp3(a,c,f):"ogg"==b?n.convertToOgg(a,c,f):"wav"==b?n.convertToWav(a,
c,f):"m4a"==b?n.convertToM4a(a,c,f):(d.debug("unknown format",b),null!=f&&f())};n.isSoundFile=function(a){a=d.path.extname(a);return".mp3"==a||".ogg"==a||".m4a"==a||".wav"==a};n.getBaseName=function(a){return d.path.dirname(a)+d.path.sep+d.path.basename(a,d.path.extname(a))};n.exec=function(a,b){var c=d.path.resolve("bin/audio");d.cfg.ffmpegPath&&d.cfg.ffmpegPath&&(c=d.path.resolve(d.cfg.ffmpegPath));d.child.exec(c+" "+a,function(a){null!=a&&(d.debug("Sound -> exec error: "+a),n.errors.push(a));null!=
b&&b()})};var L=function(a,b,c,f){this.serverPluginChanges=null;this.useTimestamp=this.useSocket=!1;this.engineIncludesFile="engine/LoaderIncludes.js";this.releaseMode=!1;this.project=a;this.editor=f;this.cbx=c;this.project.isBroken()?(d.debug("Failed deploy","Broken project"),this.cb()):(this.report={errors:"",warnings:"",info:"",closureReport:"",release:""},this.options=b,this.branchId=b.branch,this.projectPath=a.getPath(),this.path=this.projectPath+"/"+i.string(d.cfg.deployPath)+"/"+i.string(this.branchId),
a=this.projectPath+"/"+i.string(d.cfg.releasePath)+"/"+b.name,null!=b.releasePath&&""!=b.releasePath&&d.fs.existsSync(b.releasePath)&&(a=b.releasePath+"/"+b.name),this.releasePath=a,this.resourcePath=this.path+"/default",this.engineIncludesFile=this.projectPath+"/"+this.engineIncludesFile,d.fs.existsSync(this.projectPath+"/engine/MightyLoader.js")&&(this.releaseMode=!0),d.fs.exists(this.path,s(this,this.checkDirs)))};L.__name__=!0;L.prototype={zipFiles:function(a){d.mkzip(this.releasePath+i.string(d.path.sep)+
i.string(this.options.name)+".zip",this.releasePath,a)},execDeployHook:function(a,b,c){var f=this,e=d.path.resolve(a);d.exec(e,[this.project.name,this.project.getBranchName(this.branchId),this.options.name],function(a,b){f.report.errors+="script: "+e+" error: "+a+"\r\n"+b+"\r\n";c()},b)},runScript:function(a,b){null==b&&(b=0);var c=this;if(!this.options.script||""==this.options.script)null!=a&&a();else{var f;f={cwd:this.releasePath+"/",env:process.env};var e=this.options.script;"/"!=e.substring(0,
1)?b==d.cfg.deployHooksPaths.length?this.report.errors+="Failed to exec: "+i.string(this.options.script)+": NOT FOUND":(e=this.projectPath+"/"+d.cfg.deployHooksPaths[b]+"/"+i.string(this.options.script),d.fs.exists(e,function(d){d?c.execDeployHook(e,f,a):(b++,c.runScript(a,b))})):this.execDeployHook(e,f,a)}},parseIndex:function(a,b,c){if(null!=a)d.debug("Deploy::parseIndex -> error reading file",a);else{a="";this.useTimestamp&&(a="?"+m.getTime());var b=m.splitInLines(b),f="",e="fullSources";this.options.useClosureCompiler&&
(e="full.min");var h="";this.options.cocoonJS&&(h='<script type="text/javascript" src="engine/library/CocoonJSExtensions/CocoonJS.js"><\/script>\r\n<script type="text/javascript" src="engine/library/CocoonJSExtensions/CocoonJS_App.js"><\/script>\r\n<script type="text/javascript" src="engine/library/CocoonJSExtensions/CocoonJS_App_ForCocoonJS.js"><\/script>\r\n');for(var r="",j=0;j<b.length;)if(r=b[j],++j,!(-1<r.indexOf("engine/library/editor.js")))if(-1<r.indexOf("</head>"))f+=h+"\r\n"+i.string(r)+
"\r\n";else if(!((!this.useSocket||this.options.cocoonJS)&&-1<r.indexOf("/socket.io/socket.io.js"))&&!(-1<r.indexOf("debug.js")))r=r.replace(".css",".css"+a).replace("engine/init.js",e+".js"+a).replace("engine/MightyLoader.js",e+".js"+a),f+=i.string(r)+"\r\n";d.fs.writeFile(this.releasePath+"/index.html",f,"utf-8",function(a){null==a&&null!=c&&c()})}},copySources:function(a,b,c){null==b&&(b=0);var f=this;if(b>=a.length)null!=c&&c();else{var e=this.projectPath+a[b],h=this.releasePath+a[b],r=d.path.resolve(this.projectPath+
i.string(d.path.sep)+i.string(d.cfg.deployPath));g.copy(e,h,function(){f.copySources(a,++b,function(){c()})},function(a,b,c){return!(c.isDirectory()&&d.path.resolve(a)==r)})}},minimizeSources:function(a,b){var c=this,f=d.require(b).paths;g.rm(this.releasePath,function(){var b=new E(3,function(){c.cb()});c.copySources(f,0,s(b,b.done));d.fs.readFile(c.projectPath+"/index.html","utf-8",function(a,d){c.parseIndex(a,d,s(b,b.done))});a=a.split('"use strict";').join("");d.fs.writeFile(c.releasePath+"/fullSources.js",
"var global = {};window.gParams = {release: true, rel: true};\r\n"+i.string(a)+"\r\n","utf-8",function(a){a&&d.debug("Deploy::minimizeSources -> fullSources.js -> error",a);c.report.release=d.path.resolve(c.releasePath);if(c.options.useClosureCompiler){b.add();try{d.child.exec("java -jar bin/compiler.jar  --language_in "+i.string(c.options.closureCompiler.language_in)+" --compilation_level "+i.string(c.options.closureCompiler.compilation_level)+" "+i.string(c.options.closureCompiler.compilerFlags)+
" --js "+c.releasePath+"/fullSources.js  --js_output_file "+c.releasePath+"/full.min.js ",function(a,b,f){d.debug("stdout: "+b);d.debug("stderr: "+f);null!=a&&d.debug("compilation done with errors");""!=f&&(c.report.closureReport+=""+f+"\r\n");""!=b&&(c.report.closureReport+="Info: "+f+"\r\n")}).on("close",function(){null!=c.editor&&c.editor.emit("deployCompleted",c.report);b.done()})}catch(f){d.debug("Deploy::Closure compiler Failed",a)}}});g.copy(c.path,c.releasePath+"/assets/deploy",s(b,b.done))},
!0)},checkProject:function(a){var b=this,c=this.projectPath+i.string(d.path.sep)+i.string(d.cfg.editorPath)+i.string(d.path.sep)+i.string(d.cfg.projectConfigFile),f=d.cfg.newProjectTemplates+d.path.sep+d.cfg.defaultProjectTemplate+d.path.sep+d.cfg.editorPath+d.path.sep+d.cfg.projectConfigFile;d.fs.exists(c,function(e){e?b.minimizeSources(a,c):g.copy(f,c,function(e){e?d.debug("Failed to locate",e,f):b.minimizeSources(a,c)})})},prepareSources:function(a){var b=this;d.fs.exists(this.releasePath,function(c){c?
b.checkProject(a):g.mkdir(b.releasePath,function(){b.checkProject(a)})})},parseIncludes:function(a,b,c){null==b&&(b="");var f=this;if(this.releaseMode){for(var e=0;e<a.length;){var h=a[e];++e;b+="//"+this.projectPath+"/"+h+"\r\n"+i.string(d.fs.readFileSync(this.projectPath+"/"+h,"utf-8"))+"\r\n"}c(b)}else d.fs.readFile(this.engineIncludesFile,"utf-8",function(e,h){if(e)d.debug("Deploy: Failed to parse Includes",e);else{for(var g=m.splitInLines(h),p="",P="",t="",k=0;k<g.length;)t=g[k],++k,t=t.trim(),
0==t.indexOf('loader.rootPath = "')?p=t.substring(19,t.lastIndexOf('"')):0==t.indexOf('loader.path = "')?P=t.substring(15,t.lastIndexOf('"')):0==t.indexOf('loader.include("')&&(t=t.substring(16,t.lastIndexOf('");')),t=p+P+t,b+="//"+f.projectPath+"/"+t+"\r\n"+i.string(d.fs.readFileSync(f.projectPath+"/"+t,"utf-8"))+"\r\n");for(k=0;k<a.length;)g=a[k],++k,b+="//"+f.projectPath+"/"+g+"\r\n"+i.string(d.fs.readFileSync(f.projectPath+"/"+g,"utf-8"))+"\r\n";c(b)}})},readBaseIncludes:function(a,b,c,f){var e=
this;b>a.length-1?(this.releaseMode?d.debug("Deploy::REALEASE mode"):d.debug("Deploy::DEBUG mode"),f(c)):d.fs.readFile(a[b],"utf-8",function(h,r){null!=h?d.debug("Cannot find include: ",h):(c+=r,e.readBaseIncludes(a,++b,c,f))})},loadBaseIncludes:function(a,b){null==b&&(b="");for(var c=[],f=d.cfg.includes.core,e=0;e<f.length;){var h=f[e];++e;c.push(this.path+h)}f=this.releaseMode?d.cfg.includes.release:d.cfg.includes.debug;for(e=0;e<f.length;)h=f[e],++e,c.push(this.projectPath+h);this.readBaseIncludes(c,
0,b,a)},deployIncludes:function(a){for(var b=this,c='(mighty.Loader.path = (window.gParams.gPath ? window.gParams.gPath : ""));\r\n(function(){\r\nvar loader = mighty.Loader;\r\n',f=d.path.resolve(this.projectPath),e=0;e<a.length;){var h=a[e];++e;var r=d.path.resolve(i.string(f+d.path.sep)+h);if(-1==r.indexOf(f)){var j=h.split(d.path.sep).pop(),h=i.string(d.cfg.editorPath)+"/share/"+j,j=f+i.string(d.path.sep)+i.string(d.cfg.editorPath)+i.string(d.path.sep)+"share"+i.string(d.path.sep)+j;g.copy(r,
j,null)}c+='loader.include("'+h+'");\r\n'}d.fs.writeFile(this.path+i.string(d.path.sep)+"includes.js",c+"})();\r\n","utf-8");this.options.full?this.loadBaseIncludes(function(c){b.parseIncludes(a,c,s(b,b.prepareSources))}):this.cb()},scanPlugins:function(a,b,c,d,e){var h=this;c==a.length?d(b,this.branchId):g.scanDir(a[c],function(){c++;h.scanPlugins(a,b,c,d,e)},e)},collectIncludes:function(a,b,c){for(var f=this,e=new x(".*\\.js$",""),h=new x(".*\\.editor\\.js$",""),r=new x(".*\\.editorPlugin\\.js$",
""),j=[],g=b.Deploy.palette,a=[],b=0,p=d.cfg.addonsPaths.length;b<p;){var k=b++;a.push(this.projectPath+i.string(d.path.sep)+d.cfg.addonsPaths[k].path)}b=0;for(p=d.cfg.pluginsPaths.length;b<p;)k=b++,a.push(this.projectPath+i.string(d.path.sep)+d.cfg.pluginsPaths[k].path);this.scanPlugins(a,j,0,c,function(a,b,c){if(c.isDirectory())for(var c=0,p=d.cfg.pluginsPaths.length;c<p;){c=c++;b=d.path.resolve(b);c=d.path.resolve(f.project.getPath()+i.string(d.path.sep)+d.cfg.pluginsPaths[c].path+i.string(d.path.sep)+
a);if(b==c){for(b=0;b<g.length;)if(c=g[b],++b,c.name==a)return c.disabled?(d.debug("Deploy::filterPlugins -> Disabled plugin/addon",c),!1):!0;d.debug("Deploy::filterPlugins -> unknown plugin:",a)}return!0}if(h.match(a)||r.match(a))return!1;e.match(a)&&(a="",a=b.split("\\").join("/"),a=a.substring(a.indexOf("/src/")+1),j.push(a));return!1})},checkResources:function(a,b,c,f,e){d.fs.exists(b,function(d){d?g.cp(b,c+"."+f,e):n.convertToExt(a,f,b,function(){g.cp(b,c+"."+f,e)})})},deployResource:function(a,
b,c,f){c=this.project.getPrivatePath();switch(b){case "Texture":null!=a.img&&null==a.image&&(a.image=a.img);var b=c+"/upload/"+a.image,e=d.fs.statSync(b);a.ext=d.getExt(a.image);a.date=e.mtime.getTime();g.cp(b,this.resourcePath+"/img/"+a.id+"."+a.ext,f);delete a.image;break;case "Sound":null!=a.snd&&null==a.sound&&(a.sound=a.snd);b=c+"/upload/"+a.sound;c=n.getBaseName(b);e=d.fs.statSync(b);a.ext=d.getExt(a.sound);a.date=e.mtime.getTime();delete a.sound;if(!this.options.full){g.cp(b,this.resourcePath+
"/snd/"+a.id+"."+a.ext,f);break}if(!this.options.audio){f();break}var h=0,e=function(){h--;0==h&&f()},a=this.resourcePath+"/snd/"+a.id;this.options.audio.mp3&&(h++,this.checkResources(b,c+".mp3",a,"mp3",e));this.options.audio.ogg&&(h++,this.checkResources(b,c+".ogg",a,"ogg",e));this.options.audio.m4a&&(h++,this.checkResources(b,c+".m4a",a,"m4a",e));this.options.audio.wav&&(h++,this.checkResources(b,c+".wav",a,"wav",e));b=n.getErrors();if(0<b.length){a=0;for(b=b.length;a<b;)c=a++,this.report.errors.push(c)}break;
default:b=c+"/upload/"+a.file,e=d.fs.statSync(b),a.ext=d.getExt(a.file),a.date=e.mtime.getTime(),g.cp(b,this.resourcePath+"/img/"+a.id+"."+a.ext,f),delete a.file}},addTemplates:function(a,b){if(this.options.full){null==a.Resource.Templates&&(a.Resource.Templates={});var c=function(b,c,f){if(f.isDirectory()){f="";d.fs.existsSync(c+"/"+b+".js")&&(f=d.fs.readFileSync(c+"/"+b+".js","utf-8"));var j="";d.fs.existsSync(c+"/"+b+".html")&&(j=d.fs.readFileSync(c+"/"+b+".html","utf-8"));a.Resource.Templates[b]=
{js:f,html:j}}return!1};try{g.scanDir(this.projectPath+"/src/templates",b,c)}catch(f){this.report.errors+="template: "+this.projectPath+"/src/templates failed with error: "+i.string(f)+"\r\n"}}else b()},deployItems:function(a,b){var c=this,f=Object.keys(a),e,h=this.project.getPluginsType(),r=this.project.getAddonsType(),j=m.clone(b);null==j.Resource?j.Resource={Templates:{}}:j.Resource.Templates={};var g,p,k=new E(1,function(){for(var a=Object.keys(j),b="",f=0;f<a.length;){var e=a[f];++f;"string"==
m.getType(e)&&"[object Object]"!=e&&"Addon"!=e&&(b+="var "+i.string(e)+" = window."+i.string(e)+" = "+JSON.stringify(j[e],null,"\t")+";\r\n")}d.fs.writeFile(c.path+"/library.js",b,"utf-8",function(){c.collectIncludes(c.branchId,j,s(c,c.deployIncludes))})});j.Plugin||(j.Plugin={});j.Resource||(j.Resource={});j.Plugin.palette||(j.Plugin.palette=[]);j.Deploy||(j.Deploy={});j.Deploy.palette||(j.Deploy.palette=[]);for(var t=0;t<f.length;)if(e=f[t],++t,p=this.project.resolveEnums(a[e],b),e=p.editor,delete p.editor,
g=e.plugin||e.type)if(p.group=e.group,g==h)"Resource"==p.name&&(this.useTimestamp=p.useTimestamp),"Server"==p.name&&(this.serverPlugin=p,this.options.cocoonJS&&(this.serverPluginChanges={offlineMode:p.offlineMode},p.offlineMode=!0),this.useSocket=p.useSocket,p.offlineMode&&(this.useSocket=!1)),j[p.name]||(j[p.name]={}),j[p.name].Cfg=p,"Core"!=e.origin&&(j.Plugin.palette.push(p.name),j.Deploy.palette.push(p));else if(g==r)"Core"!=e.origin&&j.Deploy.palette.push(p);else if("Deploy"!=g){if("Resource"==
g){k.add();try{this.deployResource(p,e.type,this.resourcePath,s(k,k.done))}catch(l){d.debug("DEPLOY -> ERROR deployResource",p);this.report.errors+="resource: "+i.string(p.name)+" failed\r\n";k.done();continue}}p.skip||(j[g]?j[g].palette||(j[g].palette=[]):j[g]={palette:[]},j[g].palette.push(p))}k.add();this.addTemplates(j,s(k,k.done));k.done()},getIncludes:function(){var a=this;this.project.getImport(function(b,c,d){a.project.getAllItems(a.branchId,function(b){a.deployItems(b,d)})})},mkdirs:function(){var a=
this;d.fs.exists(this.resourcePath,function(b){b?a.getIncludes():a.cb()})},checkDirs:function(a){var b=this,c=new E(0,s(this,this.mkdirs));a?g.rm(this.path,function(){d.fs.exists(b.resourcePath,function(){});c.add(2);g.mkdir(b.resourcePath+"/img",function(){d.fs.mkdir(b.resourcePath+"/snd",s(c,c.done));d.fs.mkdir(b.resourcePath+"/res",s(c,c.done))})},!0):(c.add(2),g.mkdir(this.resourcePath+"/img",function(){d.fs.mkdir(b.resourcePath+"/snd",s(c,c.done));d.fs.mkdir(b.resourcePath+"/res",s(c,c.done))}))},
cb:function(){var a=this;null!=this.serverPluginChanges&&(this.serverPlugin.offlineMode=this.serverPluginChanges.offlineMode);this.project.emitAll("deployDone",null);d.debug("Deploy:: Deploy DONE!",this.options);null!=this.options&&this.options.full?this.runScript(function(){a.options.zipFiles?a.zipFiles(function(){a.cbx(a.report)}):a.cbx(a.report)}):this.cbx(this.report)},__class__:L};var G=function(a,b,c){null==c&&(c=!1);this.isStopping=!1;this.cbx=b;d.debug("custom watcher - started");this.dir=
a;this.oldFiles={};this.collectFiles(a);this.forceUpdate=c};G.__name__=!0;G.prototype={stop:function(){console.log("DirWatcher stopped");this.isStopping=!0;if(null!=this.watchers)for(var a=0,b=this.watchers;a<b.length;){var c=b[a];++a;c&&c.close()}},cb:function(a,b,c){this.isStopping||this.cbx(a,b,c)},pollingTimeout:function(){var a=this;this.isStopping||q.Timer.delay(function(){a.collectFiles(a.dir);a.forceUpdate&&a.cb(null,null,null)},d.cfg.watcherPollingTime)},compareFiles:function(a){var b=Object.keys(a),
c=Object.keys(this.oldFiles);if(b.length!=c.length)d.debug("Watcher::FS changed:","file count not match"),this.cb(null,null,null);else for(var f=c=null,e=0;e<b.length;){var h=b[e];++e;c=a[h];f=this.oldFiles[h];if(null==c||null==f){d.debug("Watcher::FS changed: no stats for file - deleted?:",h);delete a[h];delete oldFiles[h];this.cb(null,null,null);this.pollingTimeout();return}if(c.mtime.getTime()!=f.mtime.getTime()){d.debug("Watcher::FS changed: ",h);this.cb(h,c,c);this.oldFiles=a;this.pollingTimeout();
return}}this.oldFiles=a;this.pollingTimeout()},collectFiles:function(a){var b=this,c={};g.scanDir(a,function(){b.compareFiles(c)},function(a,b,d){return g.filterJsFiles(a,b,d)||d.isDirectory()?(c[b]=d,!0):!1})},__class__:G};var H=function(a,b){b.writeHead(404);b.end()};H.__name__=!0;H.prototype={__class__:H};var x=function(a,b){b=b.split("u").join("");this.r=RegExp(a,b)};x.__name__=!0;x.prototype={match:function(a){this.r.global&&(this.r.lastIndex=0);this.r.m=this.r.exec(a);this.r.s=a;return null!=
this.r.m},__class__:x};var C=function(a){var b=this;this.socket=a;this.emitData={action:null,data:null};this.rooms=[];this.socket.on("action",function(a,d){var e=b.action(a.action,a.data,d);null!=e&&null!=d&&d(e)})};C.__name__=!0;C.emitAllStatic=function(a,b,c){a={action:a,data:b};d.io.sockets["in"](c).emit("action",a)};C.prototype={emitAll:function(a,b){for(var c=0,f=this.rooms;c<f.length;){var e=f[c];++c;this.emitData.action=a;this.emitData.data=b;d.io.sockets["in"](e).emit("action",this.emitData)}},
emit:function(a,b){this.emitData.action=a;this.emitData.data=b;this.socket.emit("action",this.emitData)},leaveAllRooms:function(){for(var a=0,b=this.rooms;a<b.length;){var c=b[a];++a;this.leaveRoom(c)}},leaveRoom:function(a){u.remove(this.rooms,a);this.socket.leave(a)},joinRoom:function(a){for(var b=0,c=this.rooms;b<c.length;){var d=c[b];++b;if(d==a)return}this.rooms.push(a);this.emitAll("room joined","new participiant");this.socket.join(a)},action:function(a,b,c){var f=B.field(this,"a_"+a);if(B.isFunction(f))return f.apply(this,
[b,c]);this.emit("FIXME",[a,b]);d.debug("Not an action function",a);null!=c&&c();return null},__class__:C};var I=function(a){C.call(this,a);this.emit("setDemo",d.cfg.demoMode)};I.__name__=!0;I.__super__=C;I.prototype=O(C.prototype,{a_scripts:function(a,b){b()},a_export:function(a,b){d.debug("EXPORT called");this.project["export"](function(a){b(a)})},a_deploy:function(a,b){null!=this.project&&this.project.deploy(a,b,this)},a_delBranch:function(a,b){this.project.deleteBranch(a.id,b)},a_setBranch:function(a,
b){this.project.setBranch(a,b)},a_getBranchesTree:function(a,b){this.project.getBranchesTree(a.branch,b)},a_del:function(a){a.id?this.project.delItem(a,function(){}):d.debug("Editor::a_del -> Delete unknown item",a)},a_set:function(a,b){if(null==this.project)return{_error:"Not a project"};this.project.setItem(a,function(a){b(a)});return null},a_get:function(a,b){if(null==this.project)return{_error:"Not a project"};this.project.getItems(a,b);return null},a_del_project:function(a){var b=this;l.rmProject(a.name,
function(){g.rm(i.string(d.cfg.projectPath)+"/"+i.string(a.name),function(){b.a_get_projects(null,function(a){0<a.length?b.emitAll("setProject",a[0]):b.createNewProject("demo",function(){b.emitAll("setProject","demo")})})})})},a_getSourceTree:function(a,b){var c=this;if(null==this.project)return{_error:"Not a project"};var f={};g.scanDir(this.project.getPath()+i.string(d.path.sep)+"src",function(a){a.push(c.project.getPath()+i.string(d.path.sep)+"index.html");g.collectSources(a,function(a){b({map:a,
all:f})})},function(a,b,c){f[b]=c;f[b].isDir=c.isDirectory();return g.filterProjectFiles(a,b,c)})},a_saveFile:function(a,b){var c=d.path.resolve(a.fileName);a.isFolder?g.mkdir(a.fileName,b):d.fs.writeFile(c,a.data,function(a){b(a)})},a_getUserScripts:function(a,b){if(null==this.project)return{_error:"Not a project"};g.scanDir(this.project.getPath(),function(a){b(a)},g.filterEditorPlugins)},createProjectDone:function(a,b,c){null!=a&&d.debug("Editor::NewProject engine sources failed",a);null!=c&&c()},
createProjectCopy:function(a,b){var c=this;g.copy(d.cfg.engineSrcPath,i.string(d.cfg.projectPath)+"/"+a+"/engine",function(d){c.createProjectDone(d,a,b)})},createProjectSymlink:function(a,b){var c=this;d.fs.symlink(d.cfg.engineSrcPath,i.string(d.cfg.projectPath)+"/"+a+"/engine","junction",function(f){null!=f?(d.debug("Warning: symlink failed, proceeding with copy"),c.createProjectCopy(a,b)):c.createProjectDone(null,a,b)})},checkEngineAndLaunch:function(a,b){var c=this;d.fs.exists(i.string(d.cfg.projectPath)+
"/"+a+"/engine",function(d){d?b():c.addEngine(a,b)})},addEngine:function(a,b){d.debug("ADDING ENGINE:"+a);d.cfg.useSymlinks?this.createProjectSymlink(a,b):this.createProjectCopy(a,b)},createNewProject:function(a,b){var c=this,f=d.cfg.defaultProjectTemplate;g.copy(i.string(d.cfg.newProjectTemplates)+"/"+f,i.string(d.cfg.projectPath)+"/"+a,function(){c.addEngine(a,b)})},a_new_project:function(a,b){var c=this;""==a.name?(this.emit("error","badName "+i.string(a.name)),b({error:1})):this.a_get_projects(null,
function(f){for(var e=0;e<f.length;){var h=f[e];++e;if(h==a.name){c.emit("error","project exists "+i.string(a.name));b({error:1});return}}d.debug("NewProject::creating","about to copy");c.createNewProject(a.name,b)})},a_get_projects:function(a,b){var c=[];g.scanDirShallow(d.cfg.projectPath,function(){b(c)},function(a,b,d){d&&d.isDirectory()&&c.push(a);return!0})},a_testItems:function(a,b){this.project.checkAllItems(b)},a_getAllItems:function(a,b){null==a&&(a={branch:1});this.project.getAllItems(a.branch,
function(a){b(a)})},a_setProject:function(a){var b=this;!a||""==a?d.debug("WTF"):(this.projectName=a,this.checkEngineAndLaunch(a,function(){b.leaveAllRooms();b.joinRoom(a);l.newProject(a,function(a){b.project=a;b.project.getImport(function(a,c){b.emit("updateImport",{Import:a,ImportDef:c});var h=null;d.debug("gamePort!!!");var g=function(){d.debug("Editor::updatePort:"+b.project.getName());var a=b.project.getPort();0==a?h():b.emit("updateGamePort",a)},h=function(){q.Timer.delay(g,1E3)};g()})})}))},
__class__:I});var d=function(){var a=d.http.createServer(s(this,this.response));a.listen(d.cfg.port,d.cfg.host);a.on("error",function(a){d.debug("Server::Error",a)});try{this.initSocket(a,s(this,this.onSocketReady))}catch(b){d.debug("Server::SOCKET error",b)}d.callbacks=[]};d.__name__=!0;d.require=function(a){return require(a)};d.initModules=function(){d.http=d.require("http");d.fs=d.require("fs");d.sio=d.require("socket.io");d.path=d.require("path");d.sys=d.require("util");d.child=d.require("child_process");
d.domain=d.require("domain");d.os=d.require("os");d["const"]={EEXIST:47};d.mkzip=d.mkzipN;d.unzip=d.unzipN;process.env.PATH=d.path.resolve("./bin")+d.path.delimiter+process.env.PATH;d.debug(process.env.PATH)};d.main=function(a){d.initModules();var b;try{b=d.require("./config.js").config}catch(c){d.debug("reading config failed, continue with default config",c),b=d.require("./configDefault.js").config}a&&(b=m.mergeObjects(a,b));d.cfg=b;d.fs.exists||(d.fs.exists=d.path.exists);d.fs.exists(d.path.resolve(d.cfg.tmpPath),
function(a){a||g.mkdir(d.path.resolve(d.cfg.tmpPath),d.emptyFn)})};d.emptyFn=function(){};d.addWatcherCallback=function(a){d.callbacks.push(a)};d.mkzipN=function(a,b,c){d.debug("executing zip",a,b);var f=d.domain.create();f.on("error",function(f){d.debug("ZIP:Error",f);d.mkzip=d.mkzipJs;d.mkzipJs(a,b,c)});f.run(function(){var f;f={cwd:d.path.resolve(b),env:process.env};d.debug("ZIP CMD::",d.progs.zip+" -rvq "+i.string(d.path.resolve(a))+" ./");f=d.child.spawn(d.progs.zip,["-rvq",d.path.resolve(a),
"./"],f);f.on("exit",function(f){0!=f?(d.debug("Server::Core","Falling back to zip JS"),d.mkzip=d.mkzipJs,d.mkzipJs(a,b,c)):c("ZIP DONE")});f.stdout.on("data",function(a){d.debug("ZIP:",a.toString())})})};d.unzipN=function(a,b,c){d.debug("ZIP called",a,b);var f=d.domain.create();f.on("error",function(f){d.debug("spawn failed",f);d.debug("Server::Core","Falling back to unzip JS");d.unzip=d.unzipJs;d.unzipJs(a,b,c)});f.run(function(){var f=d.child.spawn("unzip",["-d",b,a],null);f.on("exit",function(){c()});
f.stdout.on("data",function(a){d.debug("UNZIP:",a.toString())})})};d.exec=function(a,b,c,f){var e=d.domain.create(),h="";e.on("error",function(a){d.debug("spawn failed",a);c&&c(h)});e.run(function(){var e=d.child.spawn(a,b,f);e.stdout.on("data",function(a){d.debug("Server.exec - > Process:",a.toString());h+=a.toString()});e.on("exit",function(a){c&&c(h,a)});e.stderr.on("data",function(a){d.debug("stderr: "+a)})})};d.mkzipJs=function(a,b,c){var f=new (d.require("node-native-zip"));g.scanDir(b,function(e){g.collectSources(e,
function(e){for(var g=Object.keys(e),j=0;j<g.length;){var i=g[j];++j;try{f.add(i.substring(b.length+1),e[i])}catch(p){d.debug("zip add failed",p)}}d.fs.writeFile(a,f.toBuffer(),function(){c("ZIP DONE")})})})};d.unzipJs=function(a,b,c){d.debug("unzip to:",b);d.debug("unZIP called",a,b);var f=d.require("zip");d.fs.readFile(a,function(a,h){var r=f.Reader(h);r.toObject();var j=new E(0,function(){null!=c&&c()});r.forEach(function(a){var c=a.getName(),f=c.split("/");f.pop();f=b+"/"+f.join("/");j.add();
g.mkdir(f,function(){var f=a.getData();d.fs.writeFile(b+"/"+i.string(c),f,s(j,j.done))})});var k;k=r instanceof Array?function(){return u.iter(r)}:"function"==typeof r.iterator?s(r,r.iterator):r.iterator;k()})};d.handleError=function(a,b,c){c.setHeader("Content-Type","text/plain");c.writeHead(404);c.write("Error");c.write(a+"\r\n<br />");c.write(q.Json.stringify(b));c.write("\r\n");c.end("Not found\n")};d.getMime=function(a){return d.cfg.mimes[a]};d.getExt=function(a){return a.substring(a.lastIndexOf(".")+
1)};d.getUrlParams=function(a){for(var a=a.substring(a.lastIndexOf("?")+1).split("&"),b={},c=0;c<a.length;){var d=a[c];++c;var e=d.indexOf("=");b[d.substring(0,e)]=d.substring(e+1)}return b};d.debug=function(){};d.checkAndSave=function(a,b,c){null==c&&(c=1);a=d.path.normalize(a);d.fs.exists(a,function(f){if(f){var f=d.path.normalize(a).split(d.path.sep),e=f.pop(),h=e.split("."),g="";1<h.length&&(g="."+h.pop(),e=h.join("."));var h=c+"",j=e.substring(e.length-h.length,e.length),j=parseInt(j);d.debug("New i = ",
j+1);isNaN(j)||(c=j+1);1<c&&(h=c+"",e=e.substring(0,e.length-h.length));d.debug("Checking fileName",e,h);f=i.string(f.join(d.path.sep)+d.path.sep)+e+c+g;d.checkAndSave(f,b,++c)}else b(a)})};d.mkTempName=function(a){a=a.split(".");a.splice(a.length-1,0,m.getTime());return a.join(".")};d.prototype={onDirectoryRequest:function(){},onFileNotFound:function(){},onHttpRequest:function(){return!1},onSocketReady:function(){},watchFiles:function(a){for(var b=0;b<a.length;){var c=a[b];++b;new G(c,function(a,
b,c){for(var g=0,j=d.callbacks;g<j.length;){var i=j[g];++g;i(a,b,c)}})}},initSocket:function(a,b){d.io=d.sio.listen(a);d.io.set("log level",d.cfg.logLevel);d.io.set("transports",["websocket","jsonp-polling","htmlfile","xhr-polling"]);d.io.set("close timeout",9E3);d.io.sockets.on("connection",b)},streamFile:function(a,b,c){var f=d.fs.createReadStream(a);try{f.on("open",function(){c.setHeader("Content-Type",d.getMime(b));c.setHeader("Connection","keep-alive");c.writeHead(200);f.pipe(c)}),f.on("error",
function(){c.writeHead(404);c.end("ERROR")})}catch(e){d.debug("Server::Error get filename",a)}},stat:function(a,b,c,f,e,h){var g=this;d.fs.stat(a,function(c,i){null!=c?e(i):i.isDirectory()?h(i):1E5>i.size?d.fs.readFile(a,function(c,e){null!=c?d.handleError(a,c,f):(f.setHeader("Content-Type",d.cfg.mimes[b]),f.setHeader("Connection","keep-alive"),f.writeHead(200),f.end(e))}):g.streamFile(a,b,f)})},getFile:function(a,b,c,f,e){null==e&&(e=0);var h=this;d.cfg.webRoot.length==e?(d.debug("File not found",
d.path.resolve(a,d.cfg.webRoot[e-1]+a)),this.onFileNotFound(b,c,a,d.cfg.webRoot[e-1])):this.stat(d.cfg.webRoot[e]+a,f,b,c,function(){d.cfg.webRoot.length>e-1&&h.getFile(a,b,c,f,++e)},function(){h.onDirectoryRequest(b,c,a)})},response:function(a,b){var c=a.url.indexOf("?"),d=a.url,e="";-1<c&&(d=a.url.substring(0,c));this.onHttpRequest(a,b,d)||("/"==d?(d="/index.html",e="html"):e=d.substring(d.lastIndexOf(".")+1),b.setHeader("Access-Control-Allow-Origin","*"),this.getFile(d,a,b,e))},__class__:d};var z=
function(){var a=this;d.call(this);this.watchFiles(d.cfg.watchingPaths);g.rm(d.cfg.tmpPath,function(){a.openBrowser()},!0)};z.__name__=!0;z.main=function(){d.main();d.ImportSrc=d.fs.readFileSync("Import.js","utf-8");l.exTools=d.require("../client/js/tools/tools.js").Tools;l.exOtito=d.require("../client/js/tools/otito.js").Otito;global.Tools=l.exTools;new z;d.fs.writeFile(".pidfile",process.pid);y.addAction("itemFile",{start:function(a){d.debug("UPLOADER -> itemImage",a);return i.string(d.cfg.projectPath)+
"/"+a.project+"/.editor/upload/"},finish:function(a,b){var c={success:!0,file:a.substring(a.lastIndexOf(d.path.sep)+1)};if(n.isSoundFile(a)){var f=4,e=function(){f--;0==f&&(b.write(q.Json.stringify(c)),b.end())};n.convertToMp3(a,null,e);n.convertToM4a(a,null,e);n.convertToOgg(a,null,e);n.convertToWav(a,null,e)}else b.write(q.Json.stringify(c)),b.end()}});y.addAction("itemSound",{start:function(a){d.debug("UPLOADER -> itemSound",a);return i.string(d.cfg.projectPath)+"/"+a.project+"/.editor/upload/"},
finish:function(a,b){var c={success:!0,file:a.substring(a.lastIndexOf(d.path.sep)+1)};b.write(q.Json.stringify(c));b.end()}});y.addAction("importProject",{start:function(){return i.string(d.cfg.tmpPath)+"/"},finish:function(a,b){l.importProject(a,function(a){b.write(q.Json.stringify(a));b.end()})}});process.on("exit",function(){console.log("About to exit.");z.exit()});process.on("SIGINT",function(){z.exit();process.exit(0)})};z.exit=function(){l.stopAll()};z.__super__=d;z.prototype=O(d.prototype,
{openBrowser:function(){if(d.cfg.openBrowser){var a=d.os.platform(),b="http://"+(d.cfg.host?d.cfg.host:"localhost")+":"+i.string(d.cfg.port);d.debug("opening browser",a,b);switch(a){case "linux":d.child.exec("xdg-open "+b);break;case "win":case "win32":case "win64":d.child.exec("cmd /c start "+b);d.progs.zip="zip.bat";break;default:d.child.exec("open "+b)}}},onSocketReady:function(a){new I(a)},onDirectoryRequest:function(a,b,c){this.getFile(c+"index.html",a,b,"html")},onFileNotFound:function(a,b,
c){new H(a,b,c)},onHttpRequest:function(a,b,c){return"/upload"==c?(new y(a,b),!0):-1<c.indexOf("level.php")?(new H(a,b,c),!0):!1},__class__:z});var M=function(a,b,c){this.isFailed=this.errorInConfig=!1;this.project=c;this.path=a;this.isLoading=!1;this.stack=new J("Import");this.read(b)};M.__name__=!0;M.prototype={eval:function(a){this.isFailed=!1;for(var b=d.require("vm"),c=null,c={Import:{},ImportDef:{},ImportUnResolvedEnums:{},ClientImportDef:{},console:console},f=b.createContext(c),e=Object.keys(a),
h,g,j,i=[],k=0;k<e.length;){var l=e[k];++k;try{b.runInContext(a[l],f,l)}catch(t){j=t.stack,j.replace("\r\n","\n"),g=j.split("\n"),h=g[1].substring(g[1].indexOf(d.cfg.projectPath)+d.cfg.projectPath.length+1),-1==j.indexOf(l)&&(h=l.substring(l.indexOf(d.cfg.projectPath)+d.cfg.projectPath.length+1)),i.push({error:g[0],file:h})}}try{b.runInContext("this.FixImport();",f,"")}catch(m){j=m.stack,j.replace("\r\n","\n"),g=j.split("\n"),h=g[1].substring(g[1].indexOf(d.cfg.projectPath)+d.cfg.projectPath.length+
1),i.push({error:g[0],file:h})}0<i.length?(this.project.emitAll("importError",i),this.errorInConfig=!0):this.errorInConfig=!1;this.ImportUnResolvedEnums=c.ImportUnResolvedEnums;this.ImportDef=c.ImportDef;this.Import=c.Import;this.ClientImportDef=c.ClientImportDef;this.isLoading=!1;this.stack.run().release()},collectFiles:function(a,b,c,f){var e=this;d.debug("filer to read:",a,c);c>=a.length?(d.debug("collected,",b),f(b)):g.scanDir(a[c],function(){e.collectFiles(a,b,++c,f)},g.filterEditorJs,b)},update:function(a){var b=
this;if(this.isLoading)this.stack.add(a);else{this.isLoading=!0;var c=[];c.push("./Import.js");var f=[];f.push(this.path+i.string(d.path.sep)+i.string(d.cfg.enginePath));for(var e=d.cfg.pluginsPaths,h=0;h<e.length;){var r=e[h];++h;f.push(this.path+i.string(d.path.sep)+i.string(r.path))}e=d.cfg.addonsPaths;for(h=0;h<e.length;)r=e[h],++h,f.push(this.path+i.string(d.path.sep)+i.string(r.path));this.collectFiles(f,c,0,function(c){g.collectSources(c,function(c){b.eval(c);null!=a&&a()})})}},get:function(a){var b=
this;this.isLoading?(d.debug("Import is loading..."),this.stack.add(function(){b.get(a)})):this.isFailed?d.debug("Import failed"):a(this.Import,this.ClientImportDef,this.ImportUnResolvedEnums,this.ImportDef)},read:function(a){d.debug("Import readDB");this.isLoading?d.debug("Import readDB - loading"):(this.Import={},this.ImportDef={},this.update(a))},__class__:M};var g=function(){};g.__name__=!0;g.mkdir=function(a,b){g.queue.push(function(){g._mkdir(a,function(){b();0<g.queue.length?g.queue.shift()():
g.inProgress=!1})});g.inProgress||(g.inProgress=!0,g.queue.shift()())};g._mkdir=function(a,b){d.fs.mkdir(a,function(c){if(c)if(c.errno==d["const"][c.code])b(!0);else{var f=d.path.dirname(a);f==a?(d.debug("FS::mkdir -> Error","too many recurse callbacks",a),d.debug("error: ",c,b.toString()),b(!0)):g._mkdir(f,function(c){c?b(c):g._mkdir(a,b)})}else b()})};g.copy=function(a,b,c,d){g.queue.push(function(){g._copy(a,b,function(){c&&c();0<g.queue.length?g.queue.shift()():g.inProgress=!1},d)});g.inProgress||
(g.inProgress=!0,g.queue.shift()())};g._copy=function(a,b,c,f){d.fs.stat(a,function(e,h){e?(d.debug("FS::copy",a,b),d.debug("Failed: ",e),c&&c()):f&&!f(a,b,h)?(d.debug("filtered out (skipped)",b),c&&c()):h.isDirectory()?g._mkdir(b,function(){d.fs.readdir(a,function(e,h){if(e)d.debug("FS::copy -> error",e);else{var k=0,p=function(){h.length>k?(g._copy(a+i.string(d.path.sep)+h[k],b+i.string(d.path.sep)+h[k],p,f),k++):c&&c()};p()}})}):g._mkdir(d.path.dirname(b),function(){g._cp(a,b,c)})})};g.cp=function(a,
b,c){g.queue.push(function(){g._cp(a,b,function(){c&&c();0<g.queue.length?g.queue.shift()():g.inProgress=!1})});g.inProgress||(g.inProgress=!0,g.queue.shift()())};g._cp=function(a,b,c){var f=!1,e=d.fs.createReadStream(a);e.on("error",function(f){d.debug("FS::cp -> src error",f,a);d.debug("FS::cp",a,b);g._mkdir(d.path.dirname(a),function(d){d?c():g._cp(a,b,c)})});var h=d.fs.createWriteStream(b);h.on("error",function(e){d.debug("FS::cp -> dst error",e);d.debug("FS::cp",a,b);f||(null!=c&&c(e),f=!0)});
h.on("close",function(){f||(null!=c&&c(null),f=!0)});e.pipe(h)};g.rm=function(a,b,c){null==c&&(c=!1);g.queue.push(function(){g._rm(a,function(){b&&b();0<g.queue.length?g.queue.shift()():g.inProgress=!1},c)});g.inProgress||(g.inProgress=!0,g.queue.shift()())};g._rm=function(a,b,c){d.fs.lstat(a,function(f,e){f?(d.debug("FS::rm -> error",f,a),b()):e.isDirectory()?d.fs.readdir(a,function(f,e){if(f)d.debug("FS::rm -> error",f,a),b&&b();else{var j=0,i=function(){e.length>j?(g._rm(a+d.path.sep+e[j],i,!1),
j++):c?b&&b():d.fs.rmdir(a,b)};i()}}):d.fs.unlink(a,function(a){a?d.debug("FS::rm -> error:",a):b&&b()})})};g.scanDir=function(a,b,c,d){g.queue.push(function(){g._scanDir(a,function(a){b&&b(a);0<g.queue.length?g.queue.shift()():g.inProgress=!1},c,d)});g.inProgress||(g.inProgress=!0,g.queue.shift()())};g._scanDir=function(a,b,c,f){var e;e=f?f:[];d.fs.readdir(a,function(f,i){f&&(d.debug("FS::scanDir::readdir -> error",f),i=[]);var j=0,k=!1,p=!1,l=function(){if(j<i.length){var f=a+d.path.sep+i[j];d.fs.stat(f,
function(a,h){a&&(d.debug("FS::scanDir::cbx -> error",a),b(e));p=k=!1;c&&!c(i[j],f,h)&&(k=p=!0);h.isDirectory()&&!k?(j++,g._scanDir(f,l,c,e)):(p||e.push(f),j++,l())})}else b(e)};l()})};g.scanDirShallow=function(a,b,c,d){g.queue.push(function(){g._scanDirShallow(a,function(a){b&&b(a);0<g.queue.length?g.queue.shift()():g.inProgress=!1},c,d)});g.inProgress||(g.inProgress=!0,g.queue.shift()())};g._scanDirShallow=function(a,b,c,f){var e;e=f?f:[];d.fs.readdir(a,function(f,g){f&&d.debug("FS::scanDir -> error",
f);var j=0,i=function(){if(j<g.length){var f=a+d.path.sep+g[j];d.fs.stat(f,function(a,h){a&&(d.debug("FS::scanDirShallow::cbx -> error",a),b(e));c?c(g[j],f,h)&&e.push(f):e.push(f);j++;i()})}else b(e)};i()})};g.collectSources=function(a,b){g.queue.push(function(){g._collectSources(a,function(a){b&&b(a);0<g.queue.length?g.queue.shift()():g.inProgress=!1})});g.inProgress||(g.inProgress=!0,g.queue.shift()())};g._collectSources=function(a,b){var c=0,f={},e=function(){c<a.length?d.fs.stat(a[c],function(b,
g){b?(d.debug("FS::collectSources -> error",b),c++,e()):g.isDirectory()?(c++,e(),f[a[c]]=""):d.fs.readFile(a[c],function(b,h){b&&d.debug("FS::collectSources -> failed to read file contents",b);f[a[c]]=h.toString();c++;e()})}):b(f)};e()};g.filterEditorJs=function(a,b,c){return c.isDirectory()||(new x(".*\\.editor\\.js$","")).match(a)};g.filterJsFiles=function(a,b,c){return c.isDirectory()||(new x(".*\\.js$","")).match(a)};g.filterProjectFiles=function(a,b,c){return c.isDirectory()||(new x(".*\\.js$",
"")).match(a)||(new x(".*\\.css$","")).match(a)||(new x(".*\\.html$","")).match(a)};g.filterEditorPlugins=function(a,b,c){return c.isDirectory()||(new x(".*\\.editorPlugin\\.js$","")).match(a)};var u=function(){};u.__name__=!0;u.cca=function(a,b){var c=a.charCodeAt(b);return c!=c?void 0:c};u.substr=function(a,b,c){if(null!=b&&0!=b&&null!=c&&0>c)return"";null==c&&(c=a.length);0>b?(b=a.length+b,0>b&&(b=0)):0>c&&(c=a.length+c-b);return a.substr(b,c)};u.remove=function(a,b){for(var c=0,d=a.length;c<d;){if(a[c]==
b)return a.splice(c,1),!0;c++}return!1};u.iter=function(a){return{cur:0,arr:a,hasNext:function(){return this.cur<this.arr.length},next:function(){return this.arr[this.cur++]}}};var E=function(a,b,c){null==c&&(c=!1);this.count=a;this.cb=b;this.debug=c};E.__name__=!0;E.prototype={add:function(a){null==a&&(a=1);this.debug&&d.debug("Jobs::add",a);this.count+=a},done:function(){this.count--;this.debug&&d.debug("Jobs::done",this.count);0==this.count&&this.cb()},__class__:E};var N=function(a){this.hasChanged=
!1;this.pollingTime=1E3;var b=this;this.path=a;this.isReady=!1;this.fs=d.fs;this.stack=new J("DB");this.fs.exists(a,function(c){c?b.fs.readFile(a,"utf-8",function(a,c){if(a)d.debug("DB corrupted",c),b.newDB();else try{b.data=q.Json.parse(c)}catch(h){b.newDB()}b.setReady()}):(b.newDB(),b.setReady())});this.startPolling()};N.__name__=!0;N.prototype={poll:function(){this.stack.run().release();this.hasChanged&&this.save();q.Timer.delay(s(this,this.poll),this.pollingTime)},startPolling:function(){this.poll()},
save:function(){this.hasChanged=!1;this.fs.writeFile(this.path,JSON.stringify(this.data,null,"\t"),"utf-8")},setReady:function(){this.isReady=!0;this.startPolling()},newDB:function(){d.debug("DB:: Warning!","initializing new DB");this.data={1:{items:{},sub:[],name:"root",parent:0,id:1},__auto_inc:1,__branch_id:1}},forceSave:function(){this.hasChanged=!0},getBranchName:function(a){this.data[a]||d.debug("JSON DB -> Bad branchId:",a);return this.data[a].name},getData:function(a){var b=this;this.isReady?
a(this.data):this.stack.add(function(){b.getData(a)})},delItem:function(a,b,c){var d=this;if(this.isReady){var e=this.data[b].items[a];delete this.data[b].items[a];this.hasChanged=!0;c(e,this.getItem(a,b))}else this.stack.add(function(){d.delItem(a,b,c)})},newItem:function(a){var b=this.data[a.branch].items;a.id=this.data.__auto_inc;this.data.__auto_inc++;b[a.id]=a;this.hasChanged=!0;return b},set:function(a,b,c){var d=this;if(this.isReady){var e;b.branch||(b.branch=1);null!=a?(b.id||(b.id=a),e=this.data[b.branch].items,
e[a]=b):e=this.newItem(b);c([e[b.id]]);this.hasChanged=!0}else this.stack.add(function(){d.set(a,b,c)})},getItem:function(a,b){if(!b)return[];var c=this.data[b],d=c.items[a];return d?[d]:this.getItem(a,c.parent)},getItemsFilter:function(a,b,c,d){null==c&&(c=[]);null==d&&(d={});if(!b)return c;for(var b=this.data[b],e=b.items,h=Object.keys(a),g=Object.keys(e),j,i,k=0;k<g.length;){var l=g[k];++k;j=e[l];i=!0;if(!d[l]){for(var m=0;m<h.length;){var n=h[m];++m;if(j[n]!=a[n]){i=!1;break}}i&&(d[l]=j,c.push(j))}}this.getItemsFilter(a,
b.parent,c,d);return c},get:function(a,b,c){var d=this;if(this.isReady){var e;e=null!=b.branch?b.branch:1;var h=[];null!=a?c(this.getItem(a,e)):(delete b.branch,this.getItemsFilter(b,e,h),c(h))}else this.stack.add(function(){d.get(a,b,c)})},getAllItems:function(a,b){var c=this;if(this.isReady)if(this.data[a]){var f=this.data[a].items;this.data[a].parent?this.collectBranchBuffer(a,b,{}):b(f)}else d.debug("DB::AllItems -> failed to get branch",a,this.data),b([]);else this.stack.add(function(){c.getAllItems(a,
b)})},collectBranchBuffer:function(a,b,c){for(var d=this.data[a].parent,a=this.data[a].items,e=Object.keys(a),h=0;h<e.length;){var g=e[h];++h;c[g]||(c[g]=a[g])}d?this.collectBranchBuffer(d,b,c):b(c)},collectBranches:function(a,b){if(!this.data[a])return b;var c=this.data[a];null==c.name&&(c.name="Unnamed");for(var d={id:a,name:c.name,sub:[],parent:c.parent},c=c.sub,e=0;e<c.length;){var h=c[e];++e;d.sub.push(this.collectBranches(h))}return null!=b?(b.push(d),b):d},deleteBranch:function(a){var b=this.data[a],
c=b.sub,d=this.data[b.parent].sub;u.remove(d,a);for(var e=0;e<c.length;){var h=c[e];++e;this.data[h].parent=b.parent;d.push(h)}delete this.data[a]},updateBranch:function(a){var b=this.data[a.id];b.id=a.id;b.name=a.name;var c=this.data[b.parent],d=this.data[a.parent];null!=c&&(d=d.sub,u.remove(c.sub,a.id),d.push(a.id),b.parent=a.parent)},newBranch:function(a){this.data.__branch_id++;this.data[this.data.__branch_id]={items:{},name:a.name,sub:[],parent:a.parent,id:this.data.__branch_id};this.data[a.parent].sub.push(this.data.__branch_id);
return this.data.__branch_id},setBranch:function(a,b){var c=this;this.isReady||this.stack.add(function(){c.setBranch(a,b)});var d=a.id;null==a.id?d=this.newBranch(a):this.updateBranch(a);this.hasChanged=!0;b(d)},getBranchesTree:function(a,b){var c=this;if(this.isReady){null==a&&(a=1);var d=this.collectBranches(a,[]);b(d)}else this.stack.add(function(){c.getBranchesTree(a,b)})},__class__:N};var Q=function(){};Q.__name__=!0;var D=function(a,b,c,f,e){this.inProgress=!1;d.debug("NEW Plugin obj",b+" > "+
f,e);this.itemType=b;this.cfg=c;this.project=a;this.path=f;this.origin=e;this.nameBuffer={};this.newPlugins=[]};D.__name__=!0;D.prototype={"delete":function(a,b){d.debug("Deleting plugin: reason:",b);var c=this.nameBuffer[a];null==c?d.debug("Plugins::Delete -> Item not found",a):(c.editor.color="#ff0000",c.editor.type=this.itemType,c.disabled=1,this.project.setItem({data:c,id:c.id,branch:c.editor.branch,type:this.itemType},function(a){d.debug("Plugins::Delete -> Item updated",a)},!1))},updateFS:function(a){var b=
this,c=this;d.fs.readdir(d.path.resolve(this.path),function(f,e){if(f)d.debug("Plugins::updateFS Failed to read dir",b.path,f);else{for(var h=0,g=0;g<e.length;){var j=e[g];++g;D.nameReg.match(j)&&!c.nameBuffer[j]&&(h++,b.genNew(j,b.origin,function(){h--;0==h&&b.updateFS(a)}))}if(!(0<h)){for(var i=Object.keys(c.nameBuffer),k=!1,g=0;g<i.length;){var l=i[g];++g;k=!1;if(!0!=k){for(var m=0;m<e.length;)j=e[m],++m,l==j?k=!0:c.nameBuffer[l].editor.origin!=b.origin&&(k=!0);!0!=k&&(d.debug("Cannot find:",l),
b["delete"](l,"cannot find plugin ^^^ "))}}null!=a&&a()}}})},update:function(a){var b=this;this.inProgress||(d.debug("updating plugin: "+this.itemType+" "+this.origin),this.inProgress=!0,this.nameBuffer={},this.project.getItems({where:{type:this.itemType,branch:1}},function(c){for(var d=0;d<c.length;){var e=c[d];++d;e.editor&&e.editor.origin==b.origin&&(b.nameBuffer[e.name]=e)}b.updateFS(function(){null!=a&&a();b.inProgress=!1})}))},genNew:function(a,b,c){null==b&&(b="Core");var d=this;this.project.getImport(function(e,
h,g,j){h={id:null,name:a};e="Addon"==d.itemType?l.exTools.createAddonMeta(h,e,j):l.exTools.createPluginMeta(h,e,j);e=l.genOtito(h,e).object;j={data:null,id:null,type:d.itemType,branch:1};j.data=e;j.data.name=a;j.data.editor={group:b,type:d.itemType,origin:b};d.project.setItem(j,function(a){d.nameBuffer[a[0].name]=a[0];c&&c()},!1)})},__class__:D};var l=function(a,b){null==b&&(b=!1);this.respawnServer=!0;this.needRedeploy=this.deployInProgress=!1;this.startServerRetries=0;this.broken=!1;this.port=0;
this.removing=!1;var c=this;d.debug("Opening project:",a);l.loaded.push(this);0==l.nextPort&&(l.nextPort=d.cfg.port);this.deployCbs=[];this.name=a;this.path=d.path.normalize(i.string(d.cfg.projectPath)+"/"+this.name).split("\\").join("/");this.privatePath=this.path+"/"+i.string(d.cfg.editorPath);this.enginePath=this.path+"/"+i.string(d.cfg.enginePath);this.pluginsPaths=[];for(var f=0,e=d.cfg.pluginsPaths.length;f<e;){var h=f++;this.pluginsPaths.push(this.path+"/"+d.cfg.pluginsPaths[h].path)}this.enginePluginsPath=
this.enginePath+"/"+i.string(d.cfg.enginePluginsPath);this.addonsPaths=[];f=0;for(e=d.cfg.addonsPaths.length;f<e;)h=f++,this.addonsPaths.push(this.path+"/"+d.cfg.addonsPaths[h].path);this.Import=new M(this.path,s(this,this.checkItems),this);this.db=new N(this.privatePath+"/DB.json");this.enginePlugins=new D(this,d.cfg.pluginType,"Cfg",this.enginePluginsPath,"Core");var g="";this.plugins=[];f=0;for(e=this.pluginsPaths.length;f<e;)h=f++,g=d.cfg.addonsPaths[h].origin,"project"==g&&(g=this.name),this.plugins.push(new D(this,
d.cfg.pluginType,"Cfg",this.pluginsPaths[h],g));this.addons=[];f=0;for(e=this.addonsPaths.length;f<e;)h=f++,g=d.cfg.addonsPaths[h].origin,"project"==g&&(g=this.name),this.addons.push(new D(this,d.cfg.addonType,"Addon",this.addonsPaths[h],g));this.update(function(){c.watchFiles();!b&&!d.cfg.demoMode&&c.startServer();c.broken=b;c.onStopServer=d.emptyFn;c.deploy({branch:1},null)})};l.__name__=!0;l.genOtito=function(a,b){return new l.exOtito(a,b)};l.importProject=function(a,b){var c=a.split(d.path.sep).pop().split(".").shift();
d.checkAndSave(i.string(d.cfg.projectPath)+"/"+c,function(c){var e=c.split(d.path.sep).pop();d.unzip(a,c,function(){b({success:!0,file:e})})})};l.newProject=function(a,b){var c=l.getProject(a);null!=c?b(c):d.fs.exists(i.string(d.cfg.projectPath)+"/"+a,function(c){c?b(new l(a)):(d.debug("Trying to load non existent project!!!"),b(new l(a,!0)))})};l.getProject=function(a){for(var b=0,c=l.loaded;b<c.length;){var d=c[b];++b;if(d.name==a)return d}return null};l.rmProject=function(a,b){var c=l.getProject(a);
null!=c&&c.stop(b)};l.stopAll=function(){d.debug("Project::stopAll - stopping childs");for(var a=0,b=l.loaded;a<b.length;){var c=b[a];++a;c.stop(function(){d.debug("Project node stopped")})}};l.prototype={getPort:function(){return this.port},getAddonsType:function(){return this.addons[0].itemType},getPluginsType:function(){return this.plugins[0].itemType},getName:function(){return this.name},getPrivatePath:function(){return this.privatePath},getPath:function(){return this.path},getBranchName:function(a){return this.db.getBranchName(a)},
stopServer:function(a){this.respawnServer=!1;this.onStopServer=a?a:d.emptyFn;if(null!=this.gameServer)this.gameServer.kill();else this.onStopServer()},startServerReal:function(a){var b=this,a={cwd:a};try{this.gameServer=d.child.spawn("node",["server.js",""+l.nextPort],a),this.gameServer.on("exit",function(a){b.onStopServer();d.debug("Project::Gameserver -> process exited with code "+a);b.respawnServer&&(d.debug("respawning server"),q.Timer.delay(function(){b.startServer()},1E3))}),this.gameServer.stdout.on("data",
function(a){"setNextPort"==a.toString().trim()&&d.debug("is it calling now?")}),this.gameServer.stderr.on("data",function(a){d.debug("Project::Gameserver ERROR ->\r\n--------------------",a.toString().replace("\n","\n\t")+"\r\n--------------------------------------")})}catch(c){this.respawnServer=!1,d.debug("Project::startServer -> Error spawning child",c),this.emitAll("Error","Failed to spawn child!")}q.Timer.delay(function(){b.emitAll("updateGamePort",b.port)},1E3)},startServer:function(){var a=
this;d.debug("Project::StartServer:",this.startServerRetries);l.nextPort++;this.startServerRetries++;if(10<this.startServerRetries)this.emitAll("error","error_spawn_game_server::not_starting");else{this.port=l.nextPort;var b=d.path.resolve(this.path+"/server");d.debug("Project::StartServer -> starting","server.js:"+l.nextPort);d.fs.exists(b+"/server.js",function(c){c?a.startServerReal(b):(d.debug("Project::Gameserver -> server.js not found"),a.emitAll("error","error_spawn_game_server::not_found"))})}},
stop:function(a){u.remove(l.loaded,this);this.removing=!0;this.watcher&&this.watcher.stop();this.stopServer(a)},updateProjectAddons:function(a,b){var c=this;if(b==this.addons.length)a();else{d.debug("updateAddons "+b+"/"+(this.addons.length-1));var f=b+1;this.addons[b].update(function(){c.updateProjectAddons(a,f)})}},updateProjectPlugins:function(a,b){var c=this;if(b==this.plugins.length)a();else{var d=b+1;this.plugins[b].update(function(){c.updateProjectPlugins(a,d)})}},updatePlugins:function(a){var b=
this;this.enginePlugins.update(function(){b.updateProjectPlugins(function(){b.updateProjectAddons(a,0)},0)})},update:function(a){var b=this;this.Import.update(function(){b.Import.errorInConfig?d.debug("error in config.. skipping rest checks..."):b.updatePlugins(function(){b.checkItems(function(){b.deploy({branch:1},function(){a&&a()})})})})},onSourceChanged:function(a,b,c){d.debug("Watcher event...",c);this.removing||(this.emitAll("sourceChanged",a),this.update())},watchFiles:function(){var a=this;
d.fs.stat(this.path,function(b){if(null!=b)d.debug("Project::watchFiles::Stat -> FATAL ERROR",b);else try{d.debug("Watching files"),a.watcher=d.cfg.engineDevMode?new G(a.path,s(a,a.onSourceChanged)):new G(a.path+"/src",s(a,a.onSourceChanged))}catch(c){d.debug("Project::watcher -> failed",c)}});d.addWatcherCallback(s(this,this.onSourceChanged))},emitAll:function(a,b){C.emitAllStatic(a,b,this.name)},"export":function(a){var b=d.path.resolve(i.string(d.cfg.projectPath)+"/"+this.name),c=b+"/.editor/"+
this.name+"."+i.string(d.cfg.projectExtension);d.fs.exists(c,function(f){f?d.fs.unlink(c,function(){d.mkzip(c,b,a)}):(d.debug("Project::ZIP",c,b),d.mkzip(c,b,a))})},deploy:function(a,b,c){var f=this;null!=b&&this.deployCbs.push(b);this.deployInProgress?(d.debug("Project -> Deploy in progress..."),this.needRedeploy=!0,null!=b&&b()):(this.deployInProgress=!0,new L(this,a,function(b){f.deployInProgress=!1;if(f.needRedeploy)f.needRedeploy=!1,f.deploy(a,null,c);else for(;0<f.deployCbs.length;)f.deployCbs.shift()(b)},
c))},checkAllItems:function(a){var b=this,c=[];this.Import.get(function(f,e,g,i){b.Import.errorInConfig||(b.emitAll("updateImport",{Import:f,ImportDef:e}),l.exOtito.setImport(f),l.exOtito.setImportDef(i),b.db.getData(function(e){var g=Object.keys(e);u.remove(g,"__auto_inc");u.remove(g,"__branch_id");for(var h={},k=0;k<g.length;){var n=g[k];++k;for(var n=e[n].items,q=Object.keys(n),s=0;s<q.length;){var v=q[s];++s;var w=n[v].data;if(!w){d.debug("BROKEN DB!!!!!!!!!!!!!!!!!!!!!!!!",v);return}!w.editor||
!w.editor.type?d.debug("Project -> check -> List: skipping item",w):(h[w.editor.type]||(h[w.editor.type]=m.inArray(d.cfg.noEmptyValue,w.editor.type)?{}:{"0":""}),h[w.editor.type][v]=w.name)}l.exOtito.setLists(h);for(s=0;s<q.length;)v=q[s],++s,w=n[v].data,w.editor&&("Plugin"==w.editor.type?l.exTools.createPluginMeta(w,f,i):"Addon"==w.editor.type?l.exTools.createAddonMeta(w,f,i):w.editor.plugin&&l.exTools.createMeta(w,null,null,f,i))}0<c.length&&b.db.forceSave();b.emitAll("itemsChanged",c);null!=a&&
a(c)}))})},checkItems:function(a){this.checkAllItems(a)},resolveEnums:function(a,b){var c=Object.keys(a),f;f=m.isArray(a)?[]:{};for(var e=0;e<c.length;){var g=c[e];++e;var i=a[g],j=typeof i;"object"==j&&i?f[g]=this.resolveEnums(i,b):"string"!=j?f[g]=i:0!=i.indexOf(m.enumStr)?f[g]=i:(j=m.resolveEnums(i,b),null==j?d.debug("Project::resolve enums -> Cannot resolve enum!!!",i):f[g]=j)}return f},fixAllItems:function(a){for(var b=[],c=Object.keys(a),d,e=0;e<c.length;)d=c[e],++e,d=a[d],b.push(this.fixItem(d));
return b},fixItems:function(a){for(var b=[],c=0;c<a.length;){var d=a[c];++c;b.push(this.fixItem(d))}return b},fixItem:function(a){if(!a)return d.debug("fixing item NULL"),null;a.data||(d.debug("fixing item data NULL"),a.data={});a.data.editor||(d.debug("fixing item.data.editor NULL",a),a.data.editor={});a.data.id=a.id;a.data.editor.branch=a.branch;a.data.editor.type=a.type;return a.data},deleteBranch:function(a,b){this.db.deleteBranch(a);b()},setBranch:function(a,b){var c=this;this.db.setBranch(a,
function(a){c.deploy({branch:a},function(){c.getBranchesTree(1,b)})})},getBranchesTree:function(a,b){this.db.getBranchesTree(a,b)},delItemReal:function(a,b){var c=this;this.db.delItem(a.id,a.branch,function(d,e){c.checkItems();var g=c.fixItem(d),i=c.fixItems(e);b(g,i);(null==e||0==e.length)&&c.emitAll("itemDeleted",g);c.emitAll("itemsChanged",i);c.updatePlugins(function(){c.deploy({branch:a.branch},null)})})},delItem:function(a,b){this.delItemReal(a,b)},setItem:function(a,b,c){null==c&&(c=!0);var d=
this;this.db.set(a.id,a,function(e){var g=d.fixItems(e);c?d.deploy({branch:a.branch},function(){b(g);d.emitAll("itemsChanged",g)}):(d.emitAll("itemsChanged",g),b(g))})},getAllItems:function(a,b){var c=this;this.db.getAllItems(a,function(a){b(c.fixAllItems(a))})},getItems:function(a,b){var c=this;this.db.get(a.id,a.where,function(a){b(c.fixItems(a))})},getImport:function(a){this.Import.get(a)},isBroken:function(){return this.broken},__class__:l};var B=function(){};B.__name__=!0;B.field=function(a,
b){var c=null;try{c=a[b]}catch(d){}return c};B.fields=function(a){var b=[];if(null!=a){var c=Object.prototype.hasOwnProperty,d;for(d in a)"__id__"!=d&&("hx__closures__"!=d&&c.call(a,d))&&b.push(d)}return b};B.isFunction=function(a){return"function"==typeof a&&!(a.__name__||a.__ename__)};var J=function(a,b){null==b&&(b=!1);this.name=a;this.buffer=[];this.tmpBuffer=[];this.isRunning=!1;this.debug=b};J.__name__=!0;J.prototype={release:function(){this.buffer.length=0;this.debug&&d.debug("Stack::Release",
this.name);return this},runTmp:function(){this.debug&&d.debug("Stack::RunTMP",this.name,this.tmpBuffer.length);if(0==this.tmpBuffer.length)this.isRunning=!1;else{for(var a=0,b=this.tmpBuffer;a<b.length;){var c=b[a];++a;this.buffer.push(c)}this.tmpBuffer.length=0;this.isRunning=!1;this.run()}},run:function(){if(this.isRunning)return this;this.debug&&d.debug("Stack::Run",this.name,this.buffer.length);this.isRunning=!0;for(var a=0,b=this.buffer;a<b.length;){var c=b[a];++a;c()}this.runTmp();return this},
add:function(a){this.debug&&d.debug("Stack::Add",this.name,this.buffer.length);if(this.isRunning)return this.tmpBuffer.push(a),this;this.buffer.push(a);return this},__class__:J};var i=function(){};i.__name__=!0;i.string=function(a){return v.Boot.__string_rec(a,"")};i.parseInt=function(a){var b=parseInt(a,10);if(0==b&&(120==u.cca(a,1)||88==u.cca(a,1)))b=parseInt(a);return isNaN(b)?null:b};i.parseFloat=function(a){return parseFloat(a)};var K=function(){this.b=""};K.__name__=!0;K.prototype={addSub:function(a,
b,c){this.b+=null==c?u.substr(a,b,null):u.substr(a,b,c)},__class__:K};var m=function(){};m.__name__=!0;m.clone=function(a){var b;if(!a||"object"!=typeof a)return a;if(m.isArray(a)){b=[];for(var c=0;c<a.length;){var d=a[c];++c;"object"===typeof d&&null!=d?b.push(m.clone(d)):b.push(d)}return b}b={};d=Object.keys(a);for(c=0;c<d.length;){var e=d[c];++c;var g=a[e];b[e]="object"===typeof g&&null!=g?m.clone(g):g}return b};m.mergeObjects=function(a,b){if(null==a)return m.clone(b);if(null==b)return m.clone(a);
var c=m.clone(a);if("object"!=typeof b)return c;for(var d=Object.keys(b),e=0;e<d.length;){var g=d[e];++e;var i=F["typeof"](a[g]),j=F["typeof"](b[g]);null!=i?"undefined"!=j&&(c[g]=m.mergeObjects(c[g],m.clone(b[g]))):"undefined"==i&&(c[g]=b[g])}return c};m.getType=function(a){return typeof a};m.resolveEnums=function(a,b){var c=a.substring(m.enumStr.length);return m.resolveObject(c,b)};m.resolveObject=function(a,b){var c=a.split(".");c.shift();for(var f=b,e=0;e<c.length;){var g=c[e];++e;f=f[g];if(null==
f){d.debug("Tools::resolveObject Cannot resolve",a);break}}return f};m.inArray=function(a,b){for(var c=0;c<a.length;){var d=a[c];++c;if(d==b)return!0}return!1};m.splitInLines=function(a){return a.split("\r\n").join("\n").split("\r").join("\n").split("\n")};m.isArray=function(a){return Array.isArray(a)};m.getTime=function(){return Date.now()};m.shellEscape=function(a){return a};var k={__ename__:!0,__constructs__:"TNull TInt TFloat TBool TObject TFunction TClass TEnum TUnknown".split(" "),TNull:["TNull",
0]};k.TNull.toString=A;k.TNull.__enum__=k;k.TInt=["TInt",1];k.TInt.toString=A;k.TInt.__enum__=k;k.TFloat=["TFloat",2];k.TFloat.toString=A;k.TFloat.__enum__=k;k.TBool=["TBool",3];k.TBool.toString=A;k.TBool.__enum__=k;k.TObject=["TObject",4];k.TObject.toString=A;k.TObject.__enum__=k;k.TFunction=["TFunction",5];k.TFunction.toString=A;k.TFunction.__enum__=k;k.TClass=function(a){a=["TClass",6,a];a.__enum__=k;a.toString=A;return a};k.TEnum=function(a){a=["TEnum",7,a];a.__enum__=k;a.toString=A;return a};
k.TUnknown=["TUnknown",8];k.TUnknown.toString=A;k.TUnknown.__enum__=k;var F=function(){};F.__name__=!0;F["typeof"]=function(a){switch(typeof a){case "boolean":return k.TBool;case "string":return k.TClass(String);case "number":return Math.ceil(a)==a%2147483648?k.TInt:k.TFloat;case "object":if(null==a)return k.TNull;var b=a.__enum__;if(null!=b)return k.TEnum(b);a=a.__class__;return null!=a?k.TClass(a):k.TObject;case "function":return a.__name__||a.__ename__?k.TObject:k.TFunction;case "undefined":return k.TNull;
default:return k.TUnknown}};F.enumIndex=function(a){return a[1]};var y=function(a,b){var c=d.getUrlParams(a.url);if(null==c.action)b.end(),d.debug("upload without an action",c);else{var f=y.actions[c.action];if(null==f)b.end(),d.debug("Uploader: unknown action",c);else{d.debug("Upload action",c.action);var e=f.start(c)+c.qqfile,h=d.cfg.tmpPath+d.path.sep+d.mkTempName(c.qqfile),i=d.fs.createWriteStream(d.path.resolve(h));i.on("error",function(){d.debug("Uploader::WS - could not open writestream.",
d.path.resolve(h))});i.on("close",function(){d.checkAndSave(e,function(a){d.debug("UPLOAD",a);g.copy(h,a,function(){b.writeHead(200,"OK",{"Content-Type":"text/html"});d.debug("UPLOAD DONE",a);f.finish(a,b)})})});a.on("data",function(a){i.write(a)});a.on("end",function(){i.end()})}}};y.__name__=!0;y.addAction=function(a,b){y.actions[a]=b};y.prototype={__class__:y};var q={Json:function(){}};q.Json.__name__=!0;q.Json.parse=function(a){return(new q.Json).doParse(a)};q.Json.stringify=function(a,b){return(new q.Json).toString(a,
b)};q.Json.prototype={parseNumber:function(a){for(var b=this.pos-1,c=45==a,d=!c,e=48==a,g=!1,k=!1,j=!1,l=!1;;){a=this.str.charCodeAt(this.pos++);switch(a){case 48:e&&!g&&this.invalidNumber(b);c&&(c=!1,e=!0);d=!0;break;case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:e&&!g&&this.invalidNumber(b);c&&(c=!1);d=!0;e=!1;break;case 46:(c||g)&&this.invalidNumber(b);d=!1;g=!0;break;case 101:case 69:(c||e||k)&&this.invalidNumber(b);d=!1;k=!0;break;case 43:case 45:(!k||j)&&this.invalidNumber(b);
d=!1;j=!0;break;default:d||this.invalidNumber(b),this.pos--,l=!0}if(l)break}a=i.parseFloat(u.substr(this.str,b,this.pos-b));b=a|0;return b==a?b:a},invalidNumber:function(a){throw"Invalid number at position "+a+": "+u.substr(this.str,a,this.pos-a);},parseString:function(){for(var a=this.pos,b=new K;;){var c=this.str.charCodeAt(this.pos++);if(34==c)break;if(92==c){b.addSub(this.str,a,this.pos-a-1);c=this.str.charCodeAt(this.pos++);switch(c){case 114:b.b+="\r";break;case 110:b.b+="\n";break;case 116:b.b+=
"\t";break;case 98:b.b+="\b";break;case 102:b.b+="\f";break;case 47:case 92:case 34:b.b+=String.fromCharCode(c);break;case 117:a=i.parseInt("0x"+u.substr(this.str,this.pos,4));this.pos+=4;b.b+=String.fromCharCode(a);break;default:throw"Invalid escape sequence \\"+String.fromCharCode(c)+" at position "+(this.pos-1);}a=this.pos}else if(c!=c)throw"Unclosed string";}b.addSub(this.str,a,this.pos-a-1);return b.b},parseRec:function(){for(;;){var a=this.str.charCodeAt(this.pos++);switch(a){case 32:case 13:case 10:case 9:break;
case 123:for(var b={},c=null,a=null;;){var d=this.str.charCodeAt(this.pos++);switch(d){case 32:case 13:case 10:case 9:break;case 125:return(null!=c||!1==a)&&this.invalidChar(),b;case 58:null==c&&this.invalidChar();b[c]=this.parseRec();c=null;a=!0;break;case 44:a?a=!1:this.invalidChar();break;case 34:a&&this.invalidChar();c=this.parseString();break;default:this.invalidChar()}}break;case 91:b=[];for(a=null;;)switch(d=this.str.charCodeAt(this.pos++),d){case 32:case 13:case 10:case 9:break;case 93:return!1==
a&&this.invalidChar(),b;case 44:a?a=!1:this.invalidChar();break;default:a&&this.invalidChar(),this.pos--,b.push(this.parseRec()),a=!0}break;case 116:a=this.pos;if(114!=this.str.charCodeAt(this.pos++)||117!=this.str.charCodeAt(this.pos++)||101!=this.str.charCodeAt(this.pos++))this.pos=a,this.invalidChar();return!0;case 102:a=this.pos;if(97!=this.str.charCodeAt(this.pos++)||108!=this.str.charCodeAt(this.pos++)||115!=this.str.charCodeAt(this.pos++)||101!=this.str.charCodeAt(this.pos++))this.pos=a,this.invalidChar();
return!1;case 110:a=this.pos;if(117!=this.str.charCodeAt(this.pos++)||108!=this.str.charCodeAt(this.pos++)||108!=this.str.charCodeAt(this.pos++))this.pos=a,this.invalidChar();return null;case 34:return this.parseString();case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:case 45:return this.parseNumber(a);default:this.invalidChar()}}},invalidChar:function(){this.pos--;throw"Invalid char "+this.str.charCodeAt(this.pos)+" at position "+this.pos;},doParse:function(a){this.str=
a;this.pos=0;return this.parseRec()},quote:function(a){this.buf.b+='"';for(var b=0;;){var c=a.charCodeAt(b++);if(c!=c)break;switch(c){case 34:this.buf.b+='\\"';break;case 92:this.buf.b+="\\\\";break;case 10:this.buf.b+="\\n";break;case 13:this.buf.b+="\\r";break;case 9:this.buf.b+="\\t";break;case 8:this.buf.b+="\\b";break;case 12:this.buf.b+="\\f";break;default:this.buf.b+=String.fromCharCode(c)}}this.buf.b+='"'},toStringRec:function(a,b){null!=this.replacer&&(b=this.replacer(a,b));var c=F["typeof"](b);
switch(c[1]){case 8:this.buf.b+='"???"';break;case 4:this.objString(b);break;case 1:this.buf.b+=i.string(b);break;case 2:this.buf.b+=i.string(Math.isFinite(b)?b:"null");break;case 5:this.buf.b+='"<fun>"';break;case 6:c=c[2];if(c==String)this.quote(b);else if(c==Array){c=b;this.buf.b+="[";var d=c.length;if(0<d){this.toStringRec(0,c[0]);for(var e=1;e<d;)this.buf.b+=",",this.toStringRec(e,c[e++])}this.buf.b+="]"}else if(c==q.ds.StringMap){c=b;d={};for(e=c.keys();e.hasNext();){var g=e.next();d[g]=c.get(g)}this.objString(d)}else this.objString(b);
break;case 7:e=F.enumIndex(b);this.buf.b+=i.string(e);break;case 3:this.buf.b+=i.string(b);break;case 0:this.buf.b+="null"}},objString:function(a){this.fieldsString(a,B.fields(a))},fieldsString:function(a,b){var c=!0;this.buf.b+="{";for(var d=0;d<b.length;){var e=b[d];++d;var g=B.field(a,e);B.isFunction(g)||(c?c=!1:this.buf.b+=",",this.quote(e),this.buf.b+=":",this.toStringRec(e,g))}this.buf.b+="}"},toString:function(a,b){this.buf=new K;this.replacer=b;this.toStringRec("",a);return this.buf.b},__class__:q.Json};
q.Timer=function(a){var b=this;this.id=setInterval(function(){b.run()},a)};q.Timer.__name__=!0;q.Timer.delay=function(a,b){var c=new q.Timer(b);c.run=function(){c.stop();a()};return c};q.Timer.prototype={run:function(){console.log("run")},stop:function(){null!=this.id&&(clearInterval(this.id),this.id=null)},__class__:q.Timer};q.ds={};q.ds.StringMap=function(){};q.ds.StringMap.__name__=!0;q.ds.StringMap.__interfaces__=[Q];q.ds.StringMap.prototype={keys:function(){var a=[],b;for(b in this.h)this.h.hasOwnProperty(b)&&
a.push(b.substr(1));return u.iter(a)},get:function(a){return this.h["$"+a]},__class__:q.ds.StringMap};var v={Boot:function(){}};v.Boot.__name__=!0;v.Boot.__string_rec=function(a,b){if(null==a)return"null";if(5<=b.length)return"<...>";var c=typeof a;if("function"==c&&(a.__name__||a.__ename__))c="object";switch(c){case "object":if(a instanceof Array){if(a.__enum__){if(2==a.length)return a[0];for(var c=a[0]+"(",b=b+"\t",d=2,e=a.length;d<e;)var g=d++,c=2!=g?c+(","+v.Boot.__string_rec(a[g],b)):c+v.Boot.__string_rec(a[g],
b);return c+")"}d=a.length;c="[";b+="\t";for(e=0;e<d;)g=e++,c+=(0<g?",":"")+v.Boot.__string_rec(a[g],b);return c+"]"}try{e=a.toString}catch(i){return"???"}if(null!=e&&e!=Object.toString&&(c=a.toString(),"[object Object]"!=c))return c;e=null;c="{\n";b+="\t";d=null!=a.hasOwnProperty;for(e in a)if(!d||a.hasOwnProperty(e))"prototype"==e||("__class__"==e||"__super__"==e||"__interfaces__"==e||"__properties__"==e)||(2!=c.length&&(c+=", \n"),c+=b+e+" : "+v.Boot.__string_rec(a[e],b));b=b.substring(1);return c+=
"\n"+b+"}";case "function":return"<function>";case "string":return a;default:return String(a)}};v.Boot.__interfLoop=function(a,b){if(null==a)return!1;if(a==b)return!0;var c=a.__interfaces__;if(null!=c)for(var d=0,e=c.length;d<e;){var g=d++,g=c[g];if(g==b||v.Boot.__interfLoop(g,b))return!0}return v.Boot.__interfLoop(a.__super__,b)};v.Boot.__instanceof=function(a,b){if(null==b)return!1;switch(b){case U:return(a|0)===a;case R:return"number"==typeof a;case S:return"boolean"==typeof a;case String:return"string"==
typeof a;case V:return!0;default:if(null!=a){if("function"==typeof b){if(a instanceof b)return b==Array?null==a.__enum__:!0;if(v.Boot.__interfLoop(a.__class__,b))return!0}}else return!1;return b==W&&null!=a.__name__||b==X&&null!=a.__ename__?!0:a.__enum__==b}};var T=0;Array.prototype.indexOf&&(u.remove=function(a,b){var c=a.indexOf(b);if(-1==c)return!1;a.splice(c,1);return!0});Math.__name__=["Math"];Math.NaN=Number.NaN;Math.NEGATIVE_INFINITY=Number.NEGATIVE_INFINITY;Math.POSITIVE_INFINITY=Number.POSITIVE_INFINITY;
Math.isFinite=function(a){return isFinite(a)};Math.isNaN=function(a){return isNaN(a)};String.prototype.__class__=String;String.__name__=!0;Array.prototype.__class__=Array;Array.__name__=!0;var U={__name__:["Int"]},V={__name__:["Dynamic"]},R=Number;R.__name__=["Float"];var S=Boolean;S.__ename__=["Bool"];var W={__name__:["Class"]},X={};"undefined"!=typeof JSON&&(q.Json=JSON);n.errors=[];d.progs={zip:"zip"};g.queue=[];g.inProgress=!1;D.nameReg=new x("^[a-zA-Z]+[a-zA-Z0-9]*$","");l.nextPort=0;l.loaded=
[];m.enumStr="__enum__.";y.actions={};z.main()})();
