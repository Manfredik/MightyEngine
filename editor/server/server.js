'use strict';(function(){function S(a,b){function c(){}c.prototype=a;var d=new c,e;for(e in b)d[e]=b[e];b.toString!==Object.prototype.toString&&(d.toString=b.toString);return d}function v(a,b){if(null==b)return null;null==b.__id__&&(b.__id__=W++);var c;null==a.hx__closures__?a.hx__closures__={}:c=a.hx__closures__[b.__id__];null==c&&(c=function(){return c.method.apply(c.scope,arguments)},c.scope=a,c.method=b,a.hx__closures__[b.__id__]=c);return c}var D=function(){return z.Boot.__string_rec(this,"")},
r=function(){};r.__name__=!0;r.convertToMp3=function(a,b,c){null==b&&(b=r.getBaseName(a)+".mp3");d.debug("converting sound",a,b);d.path.resolve(a)==d.path.resolve(b)?(null!=c&&c(),d.debug("Skipped MP3")):(a="-y -i "+p.shellEscape(a)+" "+p.shellEscape(b),r.exec(a,c))};r.getErrors=function(){var a=r.errors;r.errors=[];return a};r.convertToM4a=function(a,b,c){null==b&&(b=r.getBaseName(a)+".m4a");d.path.resolve(a)==d.path.resolve(b)?null!=c&&c():(a="-y -i "+p.shellEscape(a)+" -strict -2 -vn "+p.shellEscape(b),
r.exec(a,c))};r.convertToOgg=function(a,b,c){null==b&&(b=r.getBaseName(a)+".ogg");d.path.resolve(a)==d.path.resolve(b)?null!=c&&c():(a="-y -i "+p.shellEscape(a)+" -acodec libvorbis "+p.shellEscape(b),r.exec(a,c))};r.convertToWav=function(a,b,c){null==b&&(b=r.getBaseName(a)+".wav");d.path.resolve(a)==d.path.resolve(b)?null!=c&&c():(a="-y -i "+p.shellEscape(a)+" "+p.shellEscape(b),r.exec(a,c))};r.convertToExt=function(a,b,c,f){"mp3"==b?r.convertToMp3(a,c,f):"ogg"==b?r.convertToOgg(a,c,f):"wav"==b?r.convertToWav(a,
c,f):"m4a"==b?r.convertToM4a(a,c,f):(d.debug("unknown format",b),null!=f&&f())};r.isSoundFile=function(a){a=d.path.extname(a);return".mp3"==a||".ogg"==a||".m4a"==a||".wav"==a};r.getBaseName=function(a){return d.path.dirname(a)+d.path.sep+d.path.basename(a,d.path.extname(a))};r.exec=function(a,b){var c=d.path.resolve("bin/audio");d.cfg.ffmpegPath&&d.cfg.ffmpegPath&&(c=d.path.resolve(d.cfg.ffmpegPath));d.child.exec(c+" "+a,function(a){null!=a&&(d.debug("Sound -> exec error: "+a),r.errors.push("Audio exec: "+
a));null!=b&&b()})};var P=function(a,b,c,f){this.serverPluginChanges=null;this.useTimestamp=this.useSocket=!1;this.engineIncludesFile="engine/LoaderIncludes.js";this.releaseMode=!1;this.project=a;this.editor=f;this.cbx=c;this.project.isBroken()?(d.debug("Failed deploy","Broken project"),this.cb()):(this.report={errors:"",warnings:"",info:"",closureReport:"",release:""},this.options=b,this.branchId=b.branch,this.projectPath=a.getPath(),this.path=this.projectPath+"/"+i.string(d.cfg.deployPath)+"/"+
i.string(this.branchId),a=this.projectPath+"/"+i.string(d.cfg.releasePath)+"/"+b.name,null!=b.releasePath&&""!=b.releasePath&&d.fs.existsSync(b.releasePath)&&(a=b.releasePath+"/"+b.name),this.releasePath=a,this.resourcePath=this.path+"/default",this.engineIncludesFile=this.projectPath+"/"+this.engineIncludesFile,d.fs.existsSync(this.projectPath+"/engine/MightyLoader.js")&&(this.releaseMode=!0),d.fs.exists(this.path,v(this,this.checkDirs)))};P.__name__=!0;P.prototype={zipFiles:function(a){d.mkzip(this.releasePath+
i.string(d.path.sep)+i.string(this.options.name)+".zip",this.releasePath,a)},execDeployHook:function(a,b,c){var f=this,e=d.path.resolve(a);d.exec(e,[this.project.name,this.project.getBranchName(this.branchId),this.options.name],function(a,b){f.report.errors+="script: "+e+" error: "+a+"\r\n"+b+"\r\n";c()},b)},runScript:function(a,b){null==b&&(b=0);var c=this;if(!this.options.script||""==this.options.script)null!=a&&a();else{var f;f={cwd:this.releasePath+"/",env:process.env};var e=this.options.script;
"/"!=e.substring(0,1)?b==d.cfg.deployHooksPaths.length?(this.report.errors+="Failed to exec: "+i.string(this.options.script)+": NOT FOUND",a()):(e=this.projectPath+"/"+d.cfg.deployHooksPaths[b]+"/"+i.string(this.options.script),d.fs.exists(e,function(d){d?c.execDeployHook(e,f,a):(b++,c.runScript(a,b))})):this.execDeployHook(e,f,a)}},parseIndex:function(a,b,c){if(null!=a)d.debug("Deploy::parseIndex -> error reading file",a);else{a="";this.useTimestamp&&(a="?"+p.getTime());var b=p.splitInLines(b),f=
"",e="fullSources";this.options.useClosureCompiler&&(e="full.min");var g="";this.options.cocoonJS&&(g='<script type="text/javascript" src="engine/library/CocoonJSExtensions/CocoonJS.js"><\/script>\r\n<script type="text/javascript" src="engine/library/CocoonJSExtensions/CocoonJS_App.js"><\/script>\r\n<script type="text/javascript" src="engine/library/CocoonJSExtensions/CocoonJS_App_ForCocoonJS.js"><\/script>\r\n');for(var l="",j=0;j<b.length;)if(l=b[j],++j,!(-1<l.indexOf("engine/library/editor.js")))if(-1<
l.indexOf("</head>"))f+=g+"\r\n"+i.string(l)+"\r\n";else if(!((!this.useSocket||this.options.cocoonJS)&&-1<l.indexOf("/socket.io/socket.io.js"))&&!(-1<l.indexOf("debug.js")))l=l.replace(".css",".css"+a).replace("engine/init.js",e+".js"+a).replace("engine/MightyLoader.js",e+".js"+a),f+=i.string(l)+"\r\n";d.fs.writeFile(this.releasePath+"/index.html",f,"utf-8",function(a){null==a&&null!=c&&c()})}},copySources:function(a,b,c){null==b&&(b=0);var f=this;if(b>=a.length)null!=c&&c();else{var e=this.projectPath+
a[b],g=this.releasePath+a[b],l=d.path.resolve(this.projectPath+i.string(d.path.sep)+i.string(d.cfg.deployPath));h.copy(e,g,function(){f.copySources(a,++b,function(){c()})},function(a,b,c){return!(c.isDirectory()&&d.path.resolve(a)==l)})}},minimizeSources:function(a,b){var c=this,f=d.require(b).paths;h.rm(this.releasePath,function(){var b=new I(3,function(){c.cb()});c.copySources(f,0,v(b,b.done));d.fs.readFile(c.projectPath+"/index.html","utf-8",function(a,d){c.parseIndex(a,d,v(b,b.done))});a=a.split('"use strict";').join("");
d.fs.writeFile(c.releasePath+"/fullSources.js","var global = {};window.gParams = {release: true, rel: true};\r\n"+i.string(a)+"\r\n","utf-8",function(a){a&&d.debug("Deploy::minimizeSources -> fullSources.js -> error",a);c.report.release=d.path.resolve(c.releasePath);if(c.options.useClosureCompiler){b.add();try{d.child.exec("java -jar bin/compiler.jar  --language_in "+i.string(c.options.closureCompiler.language_in)+" --compilation_level "+i.string(c.options.closureCompiler.compilation_level)+" "+i.string(c.options.closureCompiler.compilerFlags)+
" --js "+c.releasePath+"/fullSources.js  --js_output_file "+c.releasePath+"/full.min.js ",function(a,b,f){d.debug("stdout: "+b);d.debug("stderr: "+f);null!=a&&d.debug("compilation done with errors");""!=f&&(c.report.closureReport+=""+f+"\r\n");""!=b&&(c.report.closureReport+="Info: "+f+"\r\n")}).on("close",function(){null!=c.editor&&c.editor.emit("deployCompleted",c.report);b.done()})}catch(f){d.debug("Deploy::Closure compiler Failed",a)}}});h.copy(c.path,c.releasePath+"/assets/deploy",v(b,b.done))},
!0)},checkProject:function(a){var b=this,c=this.projectPath+i.string(d.path.sep)+i.string(d.cfg.editorPath)+i.string(d.path.sep)+i.string(d.cfg.projectConfigFile),f=d.cfg.newProjectTemplates+d.path.sep+d.cfg.defaultProjectTemplate+d.path.sep+d.cfg.editorPath+d.path.sep+d.cfg.projectConfigFile;d.fs.exists(c,function(e){e?b.minimizeSources(a,c):h.copy(f,c,function(e){e?d.debug("Failed to locate",e,f):b.minimizeSources(a,c)})})},prepareSources:function(a){var b=this;d.fs.exists(this.releasePath,function(c){c?
b.checkProject(a):h.mkdir(b.releasePath,function(){b.checkProject(a)})})},parseIncludes:function(a,b,c){null==b&&(b="");var f=this;if(this.releaseMode){for(var e=0;e<a.length;){var g=a[e];++e;b+="//"+this.projectPath+"/"+g+"\r\n"+i.string(d.fs.readFileSync(this.projectPath+"/"+g,"utf-8"))+"\r\n"}c(b)}else d.fs.readFile(this.engineIncludesFile,"utf-8",function(e,g){if(e)d.debug("Deploy: Failed to parse Includes",e);else{for(var h=p.splitInLines(g),k="",t="",s="",x=0;x<h.length;)s=h[x],++x,s=s.trim(),
0==s.indexOf('loader.rootPath = "')?k=s.substring(19,s.lastIndexOf('"')):0==s.indexOf('loader.path = "')?t=s.substring(15,s.lastIndexOf('"')):0==s.indexOf('loader.include("')&&(s=s.substring(16,s.lastIndexOf('");')),s=k+t+s,b+="//"+f.projectPath+"/"+s+"\r\n"+i.string(d.fs.readFileSync(f.projectPath+"/"+s,"utf-8"))+"\r\n");for(x=0;x<a.length;)h=a[x],++x,b+="//"+f.projectPath+"/"+h+"\r\n"+i.string(d.fs.readFileSync(f.projectPath+"/"+h,"utf-8"))+"\r\n";c(b)}})},readBaseIncludes:function(a,b,c,f){var e=
this;b>a.length-1?(this.releaseMode?d.debug("Deploy::REALEASE mode"):d.debug("Deploy::DEBUG mode"),f(c)):d.fs.readFile(a[b],"utf-8",function(g,l){null!=g?d.debug("Cannot find include: ",g):(c+=l,e.readBaseIncludes(a,++b,c,f))})},loadBaseIncludes:function(a,b){null==b&&(b="");for(var c=[],f=d.cfg.includes.core,e=0;e<f.length;){var g=f[e];++e;c.push(this.path+g)}f=this.releaseMode?d.cfg.includes.release:d.cfg.includes.debug;for(e=0;e<f.length;)g=f[e],++e,c.push(this.projectPath+g);this.readBaseIncludes(c,
0,b,a)},deployIncludes:function(a){for(var b=this,c='(mighty.Loader.path = (window.gParams.gPath ? window.gParams.gPath : ""));\r\n(function(){\r\nvar loader = mighty.Loader;\r\n',f=d.path.resolve(this.projectPath),e=0;e<a.length;){var g=a[e];++e;var l=d.path.resolve(i.string(f+d.path.sep)+g);if(-1==l.indexOf(f)){var j=g.split(d.path.sep).pop(),g=i.string(d.cfg.editorPath)+"/share/"+j,j=f+i.string(d.path.sep)+i.string(d.cfg.editorPath)+i.string(d.path.sep)+"share"+i.string(d.path.sep)+j;h.copy(l,
j,null)}c+='loader.include("'+g+'");\r\n'}d.fs.writeFile(this.path+i.string(d.path.sep)+"includes.js",c+"})();\r\n","utf-8");this.options.full?this.loadBaseIncludes(function(c){b.parseIncludes(a,c,v(b,b.prepareSources))}):this.cb()},scanPlugins:function(a,b,c,d,e){var g=this;c==a.length?d(b,this.branchId):h.scanDir(a[c],function(){c++;g.scanPlugins(a,b,c,d,e)},e)},collectIncludes:function(a,b,c){for(var f=this,e=new A(".*\\.js$",""),g=new A(".*\\.editor\\.js$",""),l=new A(".*\\.editorPlugin\\.js$",
""),j=[],h=b.Deploy.palette,a=[],b=0,k=d.cfg.addonsPaths.length;b<k;){var t=b++;a.push(this.projectPath+i.string(d.path.sep)+d.cfg.addonsPaths[t].path)}b=0;for(k=d.cfg.pluginsPaths.length;b<k;)t=b++,a.push(this.projectPath+i.string(d.path.sep)+d.cfg.pluginsPaths[t].path);this.scanPlugins(a,j,0,c,function(a,b,c){if(c.isDirectory())for(var c=0,k=d.cfg.pluginsPaths.length;c<k;){c=c++;b=d.path.resolve(b);c=d.path.resolve(f.project.getPath()+i.string(d.path.sep)+d.cfg.pluginsPaths[c].path+i.string(d.path.sep)+
a);if(b==c){for(b=0;b<h.length;)if(c=h[b],++b,c.name==a)return c.disabled?(d.debug("Deploy::filterPlugins -> Disabled plugin/addon",c),!1):!0;d.debug("Deploy::filterPlugins -> unknown plugin:",a)}return!0}if(g.match(a)||l.match(a))return!1;e.match(a)&&(a="",a=b.split("\\").join("/"),a=a.substring(a.indexOf("/src/")+1),j.push(a));return!1})},checkResources:function(a,b,c,f,e){d.fs.exists(b,function(d){d?h.cp(b,c+"."+f,e):r.convertToExt(a,f,b,function(){h.cp(b,c+"."+f,e)})})},deployResource:function(a,
b,c,f){c=this.project.getPrivatePath();switch(b){case "Texture":null!=a.img&&null==a.image&&(a.image=a.img);var b=c+"/upload/"+a.image,e=d.fs.statSync(b);a.ext=d.getExt(a.image);a.date=e.mtime.getTime();h.cp(b,this.resourcePath+"/img/"+a.id+"."+a.ext,f);delete a.image;break;case "Sound":null!=a.snd&&null==a.sound&&(a.sound=a.snd);b=c+"/upload/"+a.sound;c=r.getBaseName(b);e=d.fs.statSync(b);a.ext=d.getExt(a.sound);a.date=e.mtime.getTime();delete a.sound;if(!this.options.full){h.cp(b,this.resourcePath+
"/snd/"+a.id+"."+a.ext,f);break}if(!this.options.audio){f();break}var g=0,e=function(){g--;0==g&&f()},a=this.resourcePath+"/snd/"+a.id;this.options.audio.mp3&&(g++,this.checkResources(b,c+".mp3",a,"mp3",e));this.options.audio.ogg&&(g++,this.checkResources(b,c+".ogg",a,"ogg",e));this.options.audio.m4a&&(g++,this.checkResources(b,c+".m4a",a,"m4a",e));this.options.audio.wav&&(g++,this.checkResources(b,c+".wav",a,"wav",e));a=r.getErrors();if(0<a.length){b=0;for(c=a.length;b<c;)e=b++,this.report.errors+=
"\r\n"+a[e]+"\r\n"}break;default:b=c+"/upload/"+a.file,e=d.fs.statSync(b),a.ext=d.getExt(a.file),a.date=e.mtime.getTime(),h.cp(b,this.resourcePath+"/img/"+a.id+"."+a.ext,f),delete a.file}},addTemplates:function(a,b){if(this.options.full){null==a.Resource.Templates&&(a.Resource.Templates={});var c=function(b,c,f){if(f.isDirectory()){f="";d.fs.existsSync(c+"/"+b+".js")&&(f=d.fs.readFileSync(c+"/"+b+".js","utf-8"));var j="";d.fs.existsSync(c+"/"+b+".html")&&(j=d.fs.readFileSync(c+"/"+b+".html","utf-8"));
a.Resource.Templates[b]={js:f,html:j}}return!1};try{h.scanDir(this.projectPath+"/src/templates",b,c)}catch(f){this.report.errors+="template: "+this.projectPath+"/src/templates failed with error: "+i.string(f)+"\r\n"}}else b()},deployItems:function(a,b){var c=this,f=Object.keys(a),e,g=this.project.getPluginsType(),l=this.project.getAddonsType(),j=p.clone(b);null==j.Resource?j.Resource={Templates:{}}:j.Resource.Templates={};var h,k,t=new I(1,function(){for(var a=Object.keys(j),b="",f=0;f<a.length;){var e=
a[f];++f;"string"==p.getType(e)&&"[object Object]"!=e&&"Addon"!=e&&(b+="var "+i.string(e)+" = window."+i.string(e)+" = "+JSON.stringify(j[e],null,"\t")+";\r\n")}d.fs.writeFile(c.path+"/library.js",b,"utf-8",function(){c.collectIncludes(c.branchId,j,v(c,c.deployIncludes))})});j.Plugin||(j.Plugin={});j.Resource||(j.Resource={});j.Plugin.palette||(j.Plugin.palette=[]);j.Deploy||(j.Deploy={});j.Deploy.palette||(j.Deploy.palette=[]);for(var s=0;s<f.length;)if(e=f[s],++s,k=this.project.resolveEnums(a[e],
b),e=k.editor,delete k.editor,h=e.plugin||e.type)if(k.group=e.group,h==g)"Resource"==k.name&&(this.useTimestamp=k.useTimestamp),"Server"==k.name&&(this.serverPlugin=k,this.options.cocoonJS&&(this.serverPluginChanges={offlineMode:k.offlineMode},k.offlineMode=!0),this.useSocket=k.useSocket,k.offlineMode&&(this.useSocket=!1)),j[k.name]||(j[k.name]={}),j[k.name].Cfg=k,"Core"!=e.origin&&(j.Plugin.palette.push(k.name),j.Deploy.palette.push(k));else if(h==l)"Core"!=e.origin&&j.Deploy.palette.push(k);else if("Deploy"!=
h){if("Resource"==h){t.add();try{this.deployResource(k,e.type,this.resourcePath,v(t,t.done))}catch(x){d.debug("DEPLOY -> ERROR deployResource",k);this.report.errors+="resource: ("+i.string(e.type)+")"+i.string(k.name)+" failed: "+i.string(x.toString())+"\r\n";t.done();continue}}k.skip||(j[h]?j[h].palette||(j[h].palette=[]):j[h]={palette:[]},j[h].palette.push(k))}t.add();this.addTemplates(j,v(t,t.done));t.done()},getIncludes:function(){var a=this;this.project.getImport(function(b,c,d){a.project.getAllItems(a.branchId,
function(b){a.deployItems(b,d)})})},mkdirs:function(){var a=this;d.fs.exists(this.resourcePath,function(b){b?a.getIncludes():a.cb()})},checkDirs:function(a){var b=this,c=new I(0,v(this,this.mkdirs));a?h.rm(this.path,function(){d.fs.exists(b.resourcePath,function(){});c.add(2);h.mkdir(b.resourcePath+"/img",function(){d.fs.mkdir(b.resourcePath+"/snd",v(c,c.done));d.fs.mkdir(b.resourcePath+"/res",v(c,c.done))})},!0):(c.add(2),h.mkdir(this.resourcePath+"/img",function(){d.fs.mkdir(b.resourcePath+"/snd",
v(c,c.done));d.fs.mkdir(b.resourcePath+"/res",v(c,c.done))}))},cb:function(){var a=this;null!=this.serverPluginChanges&&(this.serverPlugin.offlineMode=this.serverPluginChanges.offlineMode);this.project.emitAll("deployDone",null);d.debug("Deploy:: Deploy DONE!",this.options);null!=this.options&&this.options.full?this.runScript(function(){a.options.zipFiles?a.zipFiles(function(){a.cbx(a.report)}):a.cbx(a.report)}):this.cbx(this.report)},__class__:P};var K=function(a,b,c){null==c&&(c=!1);this.isStopping=
!1;this.cbx=b;d.debug("custom watcher - started");this.dir=a;this.oldFiles={};this.collectFiles(a);this.forceUpdate=c};K.__name__=!0;K.prototype={stop:function(){console.log("DirWatcher stopped");this.isStopping=!0;if(null!=this.watchers)for(var a=0,b=this.watchers;a<b.length;){var c=b[a];++a;c&&c.close()}},cb:function(a,b,c){this.isStopping||this.cbx(a,b,c)},pollingTimeout:function(){var a=this;this.isStopping||m.Timer.delay(function(){a.collectFiles(a.dir);a.forceUpdate&&a.cb(null,null,null)},d.cfg.watcherPollingTime)},
compareFiles:function(a){var b=Object.keys(a),c=Object.keys(this.oldFiles);if(b.length!=c.length)d.debug("Watcher::FS changed:","file count not match"),this.cb(null,null,null);else for(var f=c=null,e=0;e<b.length;){var g=b[e];++e;c=a[g];f=this.oldFiles[g];if(null==c||null==f){d.debug("Watcher::FS changed: no stats for file - deleted?:",g);delete a[g];delete oldFiles[g];this.cb(null,null,null);this.pollingTimeout();return}if(c.mtime.getTime()!=f.mtime.getTime()){d.debug("Watcher::FS changed: ",g);
this.cb(g,c,c);this.oldFiles=a;this.pollingTimeout();return}}this.oldFiles=a;this.pollingTimeout()},collectFiles:function(a){var b=this,c={};h.scanDir(a,function(){b.compareFiles(c)},function(a,b,d){return!d?!1:h.filterJsFiles(a,b,d)||d.isDirectory()?(c[b]=d,!0):!1})},__class__:K};var L=function(a,b){b.writeHead(404);b.end()};L.__name__=!0;L.prototype={__class__:L};var A=function(a,b){b=b.split("u").join("");this.r=RegExp(a,b)};A.__name__=!0;A.prototype={match:function(a){this.r.global&&(this.r.lastIndex=
0);this.r.m=this.r.exec(a);this.r.s=a;return null!=this.r.m},__class__:A};var E=function(a){var b=this;this.socket=a;this.emitData={action:null,data:null};this.rooms=[];this.socket.on("action",function(a,d){var e=b.action(a.action,a.data,d);null!=e&&null!=d&&d(e)})};E.__name__=!0;E.emitAllStatic=function(a,b,c){a={action:a,data:b};d.io.sockets["in"](c).emit("action",a)};E.prototype={emitAll:function(a,b){for(var c=0,f=this.rooms;c<f.length;){var e=f[c];++c;this.emitData.action=a;this.emitData.data=
b;d.io.sockets["in"](e).emit("action",this.emitData)}},emit:function(a,b){this.emitData.action=a;this.emitData.data=b;this.socket.emit("action",this.emitData)},leaveAllRooms:function(){for(var a=0,b=this.rooms;a<b.length;){var c=b[a];++a;this.leaveRoom(c)}},leaveRoom:function(a){u.remove(this.rooms,a);this.socket.leave(a)},joinRoom:function(a){for(var b=0,c=this.rooms;b<c.length;){var d=c[b];++b;if(d==a)return}this.rooms.push(a);this.emitAll("room joined","new participiant");this.socket.join(a)},
action:function(a,b,c){var f=w.field(this,"a_"+a);if(w.isFunction(f))return f.apply(this,[b,c]);this.emit("FIXME",[a,b]);d.debug("Not an action function",a);null!=c&&c();return null},__class__:E};var M=function(a){var b=this;E.call(this,a);this.emit("setDemo",d.cfg.demoMode);B.addAction("uploadBg",{start:function(a){var f=new F(b.project,null,null,b),f=i.string(d.cfg.projectPath)+"/"+i.string(a.project)+"/src/templates/"+f.normalizeName(a.template_name)+"/";if(null!=a.prev_bg_image)try{d.fs.unlinkSync(f+
y.urlDecode(a.prev_bg_image))}catch(e){}d.fs.existsSync(f)||d.fs.mkdirSync(f);f+="img/";d.fs.existsSync(f)||d.fs.mkdirSync(f);return f},finish:function(a,b){var d=a.split("/"),g=d.slice();g.splice(0,d.length-2);d.splice(0,d.length-5);d={success:!0,file:g.join("/"),path:d.join("/")};b.write(m.Json.stringify(d));b.end()}})};M.__name__=!0;M.__super__=E;M.prototype=S(E.prototype,{a_scripts:function(a,b){b()},a_export:function(a,b){d.debug("EXPORT called");this.project["export"](function(a){b(a)})},a_uiGetNormalName:function(a,
b){if(!(null==a||null==a.name)){var c=new F(this.project,a,b,this);b({normal_name:c.normalizeName(a.name)})}},a_uiRemoveFile:function(a,b){(new F(this.project,a,b,this)).removeFile()},a_deleteUITemplate:function(a,b){(new F(this.project,a,b,this)).deleteUITemplate()},a_generateHtml:function(a,b){(new F(this.project,a,b,this)).generateHtml()},a_deploy:function(a,b){null!=this.project&&this.project.deploy(a,b,this)},a_delBranch:function(a,b){this.project.deleteBranch(a.id,b)},a_setBranch:function(a,
b){this.project.setBranch(a,b)},a_getBranchesTree:function(a,b){this.project.getBranchesTree(a.branch,b)},a_del:function(a,b){a.id?this.project.delItem(a,function(){null!=b&&b()}):d.debug("Editor::a_del -> Delete unknown item",a)},a_set:function(a,b){if(null==this.project)return{_error:"Not a project"};this.project.setItem(a,function(a){b(a)});return null},a_get:function(a,b){if(null==this.project)return{_error:"Not a project"};this.project.getItems(a,b);return null},a_del_project:function(a){var b=
this;q.rmProject(a.name,function(){h.rm(i.string(d.cfg.projectPath)+"/"+i.string(a.name),function(){b.a_get_projects(null,function(a){0<a.length?b.emitAll("setProject",a[0]):b.createNewProject("demo",function(){b.emitAll("setProject","demo")})})})})},a_getSourceTree:function(a,b){var c=this;if(null==this.project)return{_error:"Not a project"};var f={};h.scanDir(this.project.getPath()+i.string(d.path.sep)+"src",function(a){a.push(c.project.getPath()+i.string(d.path.sep)+"index.html");h.collectSources(a,
function(a){b({map:a,all:f})})},function(a,b,c){f[b]=c;f[b].isDir=c.isDirectory();return h.filterProjectFiles(a,b,c)})},a_saveFile:function(a,b){var c=d.path.resolve(a.fileName);a.isFolder?h.mkdir(a.fileName,b):d.fs.writeFile(c,a.data,function(a){b(a)})},a_getUserScripts:function(a,b){if(null==this.project)return{_error:"Not a project"};h.scanDir(this.project.getPath(),function(a){b(a)},h.filterEditorPlugins)},createProjectDone:function(a,b,c){null!=a&&d.debug("Editor::NewProject engine sources failed",
a);null!=c&&c()},createProjectCopy:function(a,b){var c=this;h.copy(d.cfg.engineSrcPath,i.string(d.cfg.projectPath)+"/"+a+"/engine",function(d){c.createProjectDone(d,a,b)})},createProjectSymlink:function(a,b){var c=this;d.fs.symlink(d.cfg.engineSrcPath,i.string(d.cfg.projectPath)+"/"+a+"/engine","junction",function(f){null!=f?(d.debug("Warning: symlink failed, proceeding with copy"),c.createProjectCopy(a,b)):c.createProjectDone(null,a,b)})},checkEngineAndLaunch:function(a,b){var c=this;d.fs.exists(i.string(d.cfg.projectPath)+
"/"+a+"/engine",function(d){d?b():c.addEngine(a,b)})},addEngine:function(a,b){d.debug("ADDING ENGINE:"+a);d.cfg.useSymlinks?this.createProjectSymlink(a,b):this.createProjectCopy(a,b)},createNewProject:function(a,b){var c=this,f=d.cfg.defaultProjectTemplate;h.copy(i.string(d.cfg.newProjectTemplates)+"/"+f,i.string(d.cfg.projectPath)+"/"+a,function(){c.addEngine(a,b)})},a_new_project:function(a,b){var c=this;""==a.name?(this.emit("error","badName "+i.string(a.name)),b({error:1})):this.a_get_projects(null,
function(f){for(var e=0;e<f.length;){var g=f[e];++e;if(g==a.name){c.emit("error","project exists "+i.string(a.name));b({error:1});return}}d.debug("NewProject::creating","about to copy");c.createNewProject(a.name,b)})},a_get_projects:function(a,b){var c=[];h.scanDirShallow(d.cfg.projectPath,function(){b(c)},function(a,b,d){d&&d.isDirectory()&&c.push(a);return!0})},a_testItems:function(a,b){this.project.checkAllItems(b)},a_getAllItems:function(a,b){null==a&&(a={branch:1});this.project.getAllItems(a.branch,
function(a){b(a)})},a_setProject:function(a){var b=this;!a||""==a?d.debug("WTF"):(this.projectName=a,this.checkEngineAndLaunch(a,function(){b.leaveAllRooms();b.joinRoom(a);q.newProject(a,function(a){b.project=a;b.project.getImport(function(a,c){b.emit("updateImport",{Import:a,ImportDef:c});var g=null;d.debug("gamePort!!!");var l=function(){d.debug("Editor::updatePort:"+b.project.getName());var a=b.project.getPort();0==a?g():b.emit("updateGamePort",a)},g=function(){m.Timer.delay(l,1E3)};l()})})}))},
__class__:M});var d=function(){var a=d.http.createServer(v(this,this.response));a.listen(d.cfg.port,d.cfg.host);a.on("error",function(a){d.debug("Server::Error",a)});try{this.initSocket(a,v(this,this.onSocketReady))}catch(b){d.debug("Server::SOCKET error",b)}d.callbacks=[]};d.__name__=!0;d.require=function(a){return require(a)};d.initModules=function(){d.http=d.require("http");d.fs=d.require("fs");d.sio=d.require("socket.io");d.path=d.require("path");d.sys=d.require("util");d.child=d.require("child_process");
d.domain=d.require("domain");d.os=d.require("os");d["const"]={EEXIST:47};d.mkzip=d.mkzipN;d.unzip=d.unzipN;process.env.PATH=d.path.resolve("./bin")+d.path.delimiter+process.env.PATH;d.debug(process.env.PATH)};d.main=function(a){d.initModules();var b;try{b=d.require("./config.js").config}catch(c){d.debug("reading config failed, continue with default config",c),b=d.require("./configDefault.js").config}a&&(b=p.mergeObjects(a,b));d.cfg=b;d.fs.exists||(d.fs.exists=d.path.exists);d.fs.exists(d.path.resolve(d.cfg.tmpPath),
function(a){a||h.mkdir(d.path.resolve(d.cfg.tmpPath),d.emptyFn)})};d.emptyFn=function(){};d.addWatcherCallback=function(a){d.callbacks.push(a)};d.mkzipN=function(a,b,c){d.debug("executing zip",a,b);var f=d.domain.create();f.on("error",function(f){d.debug("ZIP:Error",f);d.mkzip=d.mkzipJs;d.mkzipJs(a,b,c)});f.run(function(){var f;f={cwd:d.path.resolve(b),env:process.env};d.debug("ZIP CMD::",d.progs.zip+" -rvq "+i.string(d.path.resolve(a))+" ./");f=d.child.spawn(d.progs.zip,["-rvq",d.path.resolve(a),
"./"],f);f.on("exit",function(f){0!=f?(d.debug("Server::Core","Falling back to zip JS"),d.mkzip=d.mkzipJs,d.mkzipJs(a,b,c)):c("ZIP DONE")});f.stdout.on("data",function(a){d.debug("ZIP:",a.toString())})})};d.unzipN=function(a,b,c){d.debug("ZIP called",a,b);var f=d.domain.create();f.on("error",function(f){d.debug("spawn failed",f);d.debug("Server::Core","Falling back to unzip JS");d.unzip=d.unzipJs;d.unzipJs(a,b,c)});f.run(function(){var f=d.child.spawn("unzip",["-d",b,a],null);f.on("exit",function(){c()});
f.stdout.on("data",function(a){d.debug("UNZIP:",a.toString())})})};d.exec=function(a,b,c,f){var e=d.domain.create(),g="";e.on("error",function(a){d.debug("spawn failed",a);c&&c(g)});e.run(function(){var e=d.child.spawn(a,b,f);e.stdout.on("data",function(a){d.debug("Server.exec - > Process:",a.toString());g+=a.toString()});e.on("exit",function(a){c&&c(g,a)});e.stderr.on("data",function(a){d.debug("stderr: "+a)})})};d.mkzipJs=function(a,b,c){var f=new (d.require("node-native-zip"));h.scanDir(b,function(e){h.collectSources(e,
function(e){for(var l=Object.keys(e),j=0;j<l.length;){var h=l[j];++j;try{f.add(h.substring(b.length+1),e[h])}catch(k){d.debug("zip add failed",k)}}d.fs.writeFile(a,f.toBuffer(),function(){c("ZIP DONE")})})})};d.unzipJs=function(a,b,c){d.debug("unzip to:",b);d.debug("unZIP called",a,b);var f=d.require("zip");d.fs.readFile(a,function(a,g){var l=f.Reader(g);l.toObject();var j=new I(0,function(){null!=c&&c()});l.forEach(function(a){var c=a.getName(),f=c.split("/");f.pop();f=b+"/"+f.join("/");j.add();
h.mkdir(f,function(){var f=a.getData();d.fs.writeFile(b+"/"+i.string(c),f,v(j,j.done))})});var H;H=l instanceof Array?function(){return u.iter(l)}:"function"==typeof l.iterator?v(l,l.iterator):l.iterator;H()})};d.handleError=function(a,b,c){c.setHeader("Content-Type","text/plain");c.writeHead(404);c.write("Error");c.write(a+"\r\n<br />");c.write(m.Json.stringify(b));c.write("\r\n");c.end("Not found\n")};d.getMime=function(a){return d.cfg.mimes[a]};d.getExt=function(a){return a.substring(a.lastIndexOf(".")+
1)};d.getUrlParams=function(a){for(var a=a.substring(a.lastIndexOf("?")+1).split("&"),b={},c=0;c<a.length;){var d=a[c];++c;var e=d.indexOf("=");b[d.substring(0,e)]=d.substring(e+1)}return b};d.debug=function(){};d.checkAndSave=function(a,b,c){null==c&&(c=1);a=d.path.normalize(a);d.fs.exists(a,function(f){if(f){var f=d.path.normalize(a).split(d.path.sep),e=f.pop(),g=e.split("."),l="";1<g.length&&(l="."+g.pop(),e=g.join("."));var g=c+"",j=e.substring(e.length-g.length,e.length),j=parseInt(j);d.debug("New i = ",
j+1);isNaN(j)||(c=j+1);1<c&&(g=c+"",e=e.substring(0,e.length-g.length));d.debug("Checking fileName",e,g);f=i.string(f.join(d.path.sep)+d.path.sep)+e+c+l;d.checkAndSave(f,b,++c)}else b(a)})};d.mkTempName=function(a){a=a.split(".");a.splice(a.length-1,0,p.getTime());return a.join(".")};d.prototype={onDirectoryRequest:function(){},onFileNotFound:function(){},onHttpRequest:function(){return!1},onSocketReady:function(){},watchFiles:function(a){for(var b=0;b<a.length;){var c=a[b];++b;new K(c,function(a,
b,c){for(var l=0,j=d.callbacks;l<j.length;){var h=j[l];++l;h(a,b,c)}})}},initSocket:function(a,b){d.io=d.sio.listen(a);d.io.set("log level",d.cfg.logLevel);d.io.set("transports",["websocket","jsonp-polling","htmlfile","xhr-polling"]);d.io.set("close timeout",9E3);d.io.sockets.on("connection",b)},streamFile:function(a,b,c){var f=d.fs.createReadStream(a);try{f.on("open",function(){c.setHeader("Content-Type",d.getMime(b));c.setHeader("Connection","keep-alive");c.writeHead(200);f.pipe(c)}),f.on("error",
function(){c.writeHead(404);c.end("ERROR")})}catch(e){d.debug("Server::Error get filename",a)}},stat:function(a,b,c,f,e,g){var l=this;d.fs.stat(a,function(c,h){null!=c?e(h):h.isDirectory()?g(h):1E5>h.size?d.fs.readFile(a,function(c,e){null!=c?d.handleError(a,c,f):(f.setHeader("Content-Type",d.cfg.mimes[b]),f.setHeader("Connection","keep-alive"),f.writeHead(200),f.end(e))}):l.streamFile(a,b,f)})},getFile:function(a,b,c,f,e){null==e&&(e=0);var g=this;d.cfg.webRoot.length==e?(d.debug("File not found",
d.path.resolve(a,d.cfg.webRoot[e-1]+a)),this.onFileNotFound(b,c,a,d.cfg.webRoot[e-1])):this.stat(d.cfg.webRoot[e]+a,f,b,c,function(){d.cfg.webRoot.length>e-1&&g.getFile(a,b,c,f,++e)},function(){g.onDirectoryRequest(b,c,a)})},response:function(a,b){var c=a.url.indexOf("?"),d=a.url,e="";-1<c&&(d=a.url.substring(0,c));this.onHttpRequest(a,b,d)||("/"==d?(d="/index.html",e="html"):e=d.substring(d.lastIndexOf(".")+1),b.setHeader("Access-Control-Allow-Origin","*"),this.getFile(d,a,b,e))},__class__:d};var C=
function(){var a=this;d.call(this);this.watchFiles(d.cfg.watchingPaths);h.rm(d.cfg.tmpPath,function(){a.openBrowser()},!0)};C.__name__=!0;C.main=function(){d.main();d.ImportSrc=d.fs.readFileSync("Import.js","utf-8");q.exTools=d.require("../client/js/tools/tools.js").Tools;q.exOtito=d.require("../client/js/tools/otito.js").Otito;global.Tools=q.exTools;new C;d.fs.writeFile(".pidfile",process.pid);B.addAction("itemFile",{start:function(a){d.debug("UPLOADER -> itemImage",a);return i.string(d.cfg.projectPath)+
"/"+a.project+"/.editor/upload/"},finish:function(a,b){var c={success:!0,file:a.substring(a.lastIndexOf(d.path.sep)+1)};if(r.isSoundFile(a)){var f=4,e=function(){f--;0==f&&(b.write(m.Json.stringify(c)),b.end())};r.convertToMp3(a,null,e);r.convertToM4a(a,null,e);r.convertToOgg(a,null,e);r.convertToWav(a,null,e)}else b.write(m.Json.stringify(c)),b.end()}});B.addAction("itemSound",{start:function(a){d.debug("UPLOADER -> itemSound",a);return i.string(d.cfg.projectPath)+"/"+a.project+"/.editor/upload/"},
finish:function(a,b){var c={success:!0,file:a.substring(a.lastIndexOf(d.path.sep)+1)};b.write(m.Json.stringify(c));b.end()}});B.addAction("importProject",{start:function(){return i.string(d.cfg.tmpPath)+"/"},finish:function(a,b){q.importProject(a,function(a){b.write(m.Json.stringify(a));b.end()})}});process.on("exit",function(){console.log("About to exit.");C.exit()});process.on("SIGINT",function(){C.exit();process.exit(0)})};C.exit=function(){q.stopAll()};C.__super__=d;C.prototype=S(d.prototype,
{openBrowser:function(){if(d.cfg.openBrowser){var a=d.os.platform(),b="http://"+(d.cfg.host?d.cfg.host:"localhost")+":"+i.string(d.cfg.port);d.debug("opening browser",a,b);switch(a){case "linux":d.child.exec("xdg-open "+b);break;case "win":case "win32":case "win64":d.child.exec("cmd /c start "+b);d.progs.zip="zip.bat";break;default:d.child.exec("open "+b)}}},onSocketReady:function(a){new M(a)},onDirectoryRequest:function(a,b,c){this.getFile(c+"index.html",a,b,"html")},onFileNotFound:function(a,b,
c){new L(a,b,c)},onHttpRequest:function(a,b,c){return"/upload"==c?(new B(a,b),!0):-1<c.indexOf("level.php")?(new L(a,b,c),!0):!1},__class__:C});var Q=function(a,b,c){this.isFailed=this.errorInConfig=!1;this.project=c;this.path=a;this.isLoading=!1;this.stack=new N("Import");this.read(b)};Q.__name__=!0;Q.prototype={eval:function(a){this.isFailed=!1;for(var b=d.require("vm"),c=null,c={Import:{},ImportDef:{},ImportUnResolvedEnums:{},ClientImportDef:{},console:console},f=b.createContext(c),e=Object.keys(a),
g,l,h,i=[],k=0;k<e.length;){var t=e[k];++k;try{b.runInContext(a[t],f,t)}catch(s){h=s.stack,h.replace("\r\n","\n"),l=h.split("\n"),g=l[1].substring(l[1].indexOf(d.cfg.projectPath)+d.cfg.projectPath.length+1),-1==h.indexOf(t)&&(g=t.substring(t.indexOf(d.cfg.projectPath)+d.cfg.projectPath.length+1)),i.push({error:l[0],file:g})}}try{b.runInContext("this.FixImport();",f,"")}catch(x){h=x.stack,h.replace("\r\n","\n"),l=h.split("\n"),g=l[1].substring(l[1].indexOf(d.cfg.projectPath)+d.cfg.projectPath.length+
1),i.push({error:l[0],file:g})}0<i.length?(this.project.emitAll("importError",i),this.errorInConfig=!0):this.errorInConfig=!1;this.ImportUnResolvedEnums=c.ImportUnResolvedEnums;this.ImportDef=c.ImportDef;this.Import=c.Import;this.ClientImportDef=c.ClientImportDef;this.isLoading=!1;this.stack.run().release()},collectFiles:function(a,b,c,f){var e=this;d.debug("filer to read:",a,c);c>=a.length?(d.debug("collected,",b),f(b)):h.scanDir(a[c],function(){e.collectFiles(a,b,++c,f)},h.filterEditorJs,b)},update:function(a){var b=
this;if(this.isLoading)this.stack.add(a);else{this.isLoading=!0;var c=[];c.push("./Import.js");var f=[];f.push(this.path+i.string(d.path.sep)+i.string(d.cfg.enginePath));for(var e=d.cfg.pluginsPaths,g=0;g<e.length;){var l=e[g];++g;f.push(this.path+i.string(d.path.sep)+i.string(l.path))}e=d.cfg.addonsPaths;for(g=0;g<e.length;)l=e[g],++g,f.push(this.path+i.string(d.path.sep)+i.string(l.path));this.collectFiles(f,c,0,function(c){h.collectSources(c,function(c){b.eval(c);null!=a&&a()})})}},get:function(a){var b=
this;this.isLoading?(d.debug("Import is loading..."),this.stack.add(function(){b.get(a)})):this.isFailed?d.debug("Import failed"):a(this.Import,this.ClientImportDef,this.ImportUnResolvedEnums,this.ImportDef)},read:function(a){d.debug("Import readDB");this.isLoading?d.debug("Import readDB - loading"):(this.Import={},this.ImportDef={},this.update(a))},__class__:Q};var h=function(){};h.__name__=!0;h.mkdir=function(a,b){h.queue.push(function(){h._mkdir(a,function(){b();0<h.queue.length?h.queue.shift()():
h.inProgress=!1})});h.inProgress||(h.inProgress=!0,h.queue.shift()())};h._mkdir=function(a,b){d.fs.mkdir(a,function(c){if(c)if(c.errno==d["const"][c.code])b(!0);else{var f=d.path.dirname(a);f==a?(d.debug("FS::mkdir -> Error","too many recurse callbacks",a),d.debug("error: ",c,b.toString()),b(!0)):h._mkdir(f,function(c){c?b(c):h._mkdir(a,b)})}else b()})};h.copy=function(a,b,c,d){h.queue.push(function(){h._copy(a,b,function(){c&&c();0<h.queue.length?h.queue.shift()():h.inProgress=!1},d)});h.inProgress||
(h.inProgress=!0,h.queue.shift()())};h._copy=function(a,b,c,f){d.fs.stat(a,function(e,g){e?(d.debug("FS::copy",a,b),d.debug("Failed: ",e),c&&c()):f&&!f(a,b,g)?(d.debug("filtered out (skipped)",b),c&&c()):g.isDirectory()?h._mkdir(b,function(){d.fs.readdir(a,function(e,g){if(e)d.debug("FS::copy -> error",e);else{var H=0,k=function(){g.length>H?(h._copy(a+i.string(d.path.sep)+g[H],b+i.string(d.path.sep)+g[H],k,f),H++):c&&c()};k()}})}):h._mkdir(d.path.dirname(b),function(){h._cp(a,b,c)})})};h.cp=function(a,
b,c){h.queue.push(function(){h._cp(a,b,function(){c&&c();0<h.queue.length?h.queue.shift()():h.inProgress=!1})});h.inProgress||(h.inProgress=!0,h.queue.shift()())};h._cp=function(a,b,c){var f=!1,e=d.fs.createReadStream(a);e.on("error",function(f){d.debug("FS::cp -> src error",f,a);d.debug("FS::cp",a,b);h._mkdir(d.path.dirname(a),function(d){d?c():h._cp(a,b,c)})});var g=d.fs.createWriteStream(b);g.on("error",function(e){d.debug("FS::cp -> dst error",e);d.debug("FS::cp",a,b);f||(null!=c&&c(e),f=!0)});
g.on("close",function(){f||(null!=c&&c(null),f=!0)});e.pipe(g)};h.rm=function(a,b,c){null==c&&(c=!1);h.queue.push(function(){h._rm(a,function(){b&&b();0<h.queue.length?h.queue.shift()():h.inProgress=!1},c)});h.inProgress||(h.inProgress=!0,h.queue.shift()())};h._rm=function(a,b,c){d.fs.lstat(a,function(f,e){f?(d.debug("FS::rm -> error",f,a),b()):e.isDirectory()?d.fs.readdir(a,function(f,e){if(f)d.debug("FS::rm -> error",f,a),b&&b();else{var j=0,i=function(){e.length>j?(h._rm(a+d.path.sep+e[j],i,!1),
j++):c?b&&b():d.fs.rmdir(a,b)};i()}}):d.fs.unlink(a,function(a){a?d.debug("FS::rm -> error:",a):b&&b()})})};h.scanDir=function(a,b,c,d){h.queue.push(function(){h._scanDir(a,function(a){b&&b(a);0<h.queue.length?h.queue.shift()():h.inProgress=!1},c,d)});h.inProgress||(h.inProgress=!0,h.queue.shift()())};h._scanDir=function(a,b,c,f){var e;e=f?f:[];d.fs.readdir(a,function(f,l){f&&(d.debug("FS::scanDir::readdir -> error",f),l=[]);var j=0,i=!1,k=!1,t=function(){if(j<l.length){var f=a+d.path.sep+l[j];d.fs.stat(f,
function(a,g){a&&(d.debug("FS::scanDir::cbx -> error",a),b(e));k=i=!1;c&&!c(l[j],f,g)&&(i=k=!0);g.isDirectory()&&!i?(j++,h._scanDir(f,t,c,e)):(k||e.push(f),j++,t())})}else b(e)};t()})};h.scanDirShallow=function(a,b,c,d){h.queue.push(function(){h._scanDirShallow(a,function(a){b&&b(a);0<h.queue.length?h.queue.shift()():h.inProgress=!1},c,d)});h.inProgress||(h.inProgress=!0,h.queue.shift()())};h._scanDirShallow=function(a,b,c,f){var e;e=f?f:[];d.fs.readdir(a,function(f,h){f&&d.debug("FS::scanDir -> error",
f);var j=0,i=function(){if(j<h.length){var f=a+d.path.sep+h[j];d.fs.stat(f,function(a,g){a&&(d.debug("FS::scanDirShallow::cbx -> error",a),b(e));c?c(h[j],f,g)&&e.push(f):e.push(f);j++;i()})}else b(e)};i()})};h.collectSources=function(a,b){h.queue.push(function(){h._collectSources(a,function(a){b&&b(a);0<h.queue.length?h.queue.shift()():h.inProgress=!1})});h.inProgress||(h.inProgress=!0,h.queue.shift()())};h._collectSources=function(a,b){var c=0,f={},e=function(){c<a.length?d.fs.stat(a[c],function(b,
h){b?(d.debug("FS::collectSources -> error",b),c++,e()):h.isDirectory()?(c++,e(),f[a[c]]=""):d.fs.readFile(a[c],function(b,g){b&&d.debug("FS::collectSources -> failed to read file contents",b);f[a[c]]=g.toString();c++;e()})}):b(f)};e()};h.filterEditorJs=function(a,b,c){return c.isDirectory()||(new A(".*\\.editor\\.js$","")).match(a)};h.filterJsFiles=function(a,b,c){return c.isDirectory()||(new A(".*\\.js$","")).match(a)};h.filterProjectFiles=function(a,b,c){return c.isDirectory()||(new A(".*\\.js$",
"")).match(a)||(new A(".*\\.css$","")).match(a)||(new A(".*\\.html$","")).match(a)};h.filterEditorPlugins=function(a,b,c){return c.isDirectory()||(new A(".*\\.editorPlugin\\.js$","")).match(a)};var u=function(){};u.__name__=!0;u.cca=function(a,b){var c=a.charCodeAt(b);return c!=c?void 0:c};u.substr=function(a,b,c){if(null!=b&&0!=b&&null!=c&&0>c)return"";null==c&&(c=a.length);0>b?(b=a.length+b,0>b&&(b=0)):0>c&&(c=a.length+c-b);return a.substr(b,c)};u.remove=function(a,b){for(var c=0,d=a.length;c<d;){if(a[c]==
b)return a.splice(c,1),!0;c++}return!1};u.iter=function(a){return{cur:0,arr:a,hasNext:function(){return this.cur<this.arr.length},next:function(){return this.arr[this.cur++]}}};var I=function(a,b,c){null==c&&(c=!1);this.count=a;this.cb=b;this.debug=c};I.__name__=!0;I.prototype={add:function(a){null==a&&(a=1);this.debug&&d.debug("Jobs::add",a);this.count+=a},done:function(){this.count--;this.debug&&d.debug("Jobs::done",this.count);0==this.count&&this.cb()},__class__:I};var R=function(a){this.hasChanged=
!1;this.pollingTime=1E3;var b=this;this.path=a;this.isReady=!1;this.fs=d.fs;this.stack=new N("DB");this.fs.exists(a,function(c){c?b.fs.readFile(a,"utf-8",function(a,c){if(a)d.debug("DB corrupted",c),b.newDB();else try{b.data=m.Json.parse(c)}catch(g){b.newDB()}b.setReady()}):(b.newDB(),b.setReady())});this.startPolling()};R.__name__=!0;R.prototype={poll:function(){this.stack.run().release();this.hasChanged&&this.save();m.Timer.delay(v(this,this.poll),this.pollingTime)},startPolling:function(){this.poll()},
save:function(){this.hasChanged=!1;this.fs.writeFile(this.path,JSON.stringify(this.data,null,"\t"),"utf-8")},setReady:function(){this.isReady=!0;this.startPolling()},newDB:function(){d.debug("DB:: Warning!","initializing new DB");this.data={1:{items:{},sub:[],name:"root",parent:0,id:1},__auto_inc:1,__branch_id:1}},forceSave:function(){this.hasChanged=!0},getBranchName:function(a){this.data[a]||d.debug("JSON DB -> Bad branchId:",a);return this.data[a].name},getData:function(a){var b=this;this.isReady?
a(this.data):this.stack.add(function(){b.getData(a)})},delItem:function(a,b,c){var d=this;if(this.isReady){var e=this.data[b].items[a];delete this.data[b].items[a];this.hasChanged=!0;c(e,this.getItem(a,b))}else this.stack.add(function(){d.delItem(a,b,c)})},newItem:function(a){var b=this.data[a.branch].items;a.id=this.data.__auto_inc;this.data.__auto_inc++;b[a.id]=a;this.hasChanged=!0;return b},set:function(a,b,c){var d=this;if(this.isReady){var e;b.branch||(b.branch=1);null!=a?(b.id||(b.id=a),e=this.data[b.branch].items,
e[a]=b):e=this.newItem(b);c([e[b.id]]);this.hasChanged=!0}else this.stack.add(function(){d.set(a,b,c)})},getItem:function(a,b){if(!b)return[];var c=this.data[b],d=c.items[a];return d?[d]:this.getItem(a,c.parent)},getItemsFilter:function(a,b,c,d){null==c&&(c=[]);null==d&&(d={});if(!b)return c;for(var b=this.data[b],e=b.items,g=Object.keys(a),h=Object.keys(e),j,i,k=0;k<h.length;){var t=h[k];++k;j=e[t];i=!0;if(!d[t]){for(var s=0;s<g.length;){var x=g[s];++s;if(j[x]!=a[x]){i=!1;break}}i&&(d[t]=j,c.push(j))}}this.getItemsFilter(a,
b.parent,c,d);return c},get:function(a,b,c){var d=this;if(this.isReady){var e;e=null!=b.branch?b.branch:1;var g=[];null!=a?c(this.getItem(a,e)):(delete b.branch,this.getItemsFilter(b,e,g),c(g))}else this.stack.add(function(){d.get(a,b,c)})},getAllItems:function(a,b){var c=this;if(this.isReady)if(this.data[a]){var f=this.data[a].items;this.data[a].parent?this.collectBranchBuffer(a,b,{}):b(f)}else d.debug("DB::AllItems -> failed to get branch",a,this.data),b([]);else this.stack.add(function(){c.getAllItems(a,
b)})},collectBranchBuffer:function(a,b,c){for(var d=this.data[a].parent,a=this.data[a].items,e=Object.keys(a),g=0;g<e.length;){var h=e[g];++g;c[h]||(c[h]=a[h])}d?this.collectBranchBuffer(d,b,c):b(c)},collectBranches:function(a,b){if(!this.data[a])return b;var c=this.data[a];null==c.name&&(c.name="Unnamed");for(var d={id:a,name:c.name,sub:[],parent:c.parent},c=c.sub,e=0;e<c.length;){var g=c[e];++e;d.sub.push(this.collectBranches(g))}return null!=b?(b.push(d),b):d},deleteBranch:function(a){var b=this.data[a],
c=b.sub,d=this.data[b.parent].sub;u.remove(d,a);for(var e=0;e<c.length;){var g=c[e];++e;this.data[g].parent=b.parent;d.push(g)}delete this.data[a]},updateBranch:function(a){var b=this.data[a.id];b.id=a.id;b.name=a.name;var c=this.data[b.parent],d=this.data[a.parent];null!=c&&(d=d.sub,u.remove(c.sub,a.id),d.push(a.id),b.parent=a.parent)},newBranch:function(a){this.data.__branch_id++;this.data[this.data.__branch_id]={items:{},name:a.name,sub:[],parent:a.parent,id:this.data.__branch_id};this.data[a.parent].sub.push(this.data.__branch_id);
return this.data.__branch_id},setBranch:function(a,b){var c=this;this.isReady||this.stack.add(function(){c.setBranch(a,b)});var d=a.id;null==a.id?d=this.newBranch(a):this.updateBranch(a);this.hasChanged=!0;b(d)},getBranchesTree:function(a,b){var c=this;if(this.isReady){null==a&&(a=1);var d=this.collectBranches(a,[]);b(d)}else this.stack.add(function(){c.getBranchesTree(a,b)})},__class__:R};var T=function(){};T.__name__=!0;var G=function(a,b,c,f,e){this.inProgress=!1;d.debug("NEW Plugin obj",b+" > "+
f,e);this.itemType=b;this.cfg=c;this.project=a;this.path=f;this.origin=e;this.nameBuffer={};this.newPlugins=[]};G.__name__=!0;G.prototype={"delete":function(a,b){d.debug("Deleting plugin: reason:",b);var c=this.nameBuffer[a];null==c?d.debug("Plugins::Delete -> Item not found",a):(c.editor.color="#ff0000",c.editor.type=this.itemType,c.disabled=1,this.project.setItem({data:c,id:c.id,branch:c.editor.branch,type:this.itemType},function(a){d.debug("Plugins::Delete -> Item updated",a)},!1))},updateFS:function(a){var b=
this,c=this;d.fs.readdir(d.path.resolve(this.path),function(f,e){if(f)d.debug("Plugins::updateFS Failed to read dir",b.path,f);else{for(var g=0,h=0;h<e.length;){var j=e[h];++h;G.nameReg.match(j)&&!c.nameBuffer[j]&&(g++,b.genNew(j,b.origin,function(){g--;0==g&&b.updateFS(a)}))}if(!(0<g)){for(var i=Object.keys(c.nameBuffer),k=!1,h=0;h<i.length;){var t=i[h];++h;k=!1;if(!0!=k){for(var s=0;s<e.length;)j=e[s],++s,t==j?k=!0:c.nameBuffer[t].editor.origin!=b.origin&&(k=!0);!0!=k&&(d.debug("Cannot find:",t),
b["delete"](t,"cannot find plugin ^^^ "))}}null!=a&&a()}}})},update:function(a){var b=this;this.inProgress||(d.debug("updating plugin: "+this.itemType+" "+this.origin),this.inProgress=!0,this.nameBuffer={},this.project.getItems({where:{type:this.itemType,branch:1}},function(c){for(var d=0;d<c.length;){var e=c[d];++d;e.editor&&e.editor.origin==b.origin&&(b.nameBuffer[e.name]=e)}b.updateFS(function(){null!=a&&a();b.inProgress=!1})}))},genNew:function(a,b,c){null==b&&(b="Core");var d=this;this.project.getImport(function(e,
g,h,j){g={id:null,name:a};e="Addon"==d.itemType?q.exTools.createAddonMeta(g,e,j):q.exTools.createPluginMeta(g,e,j);e=q.genOtito(g,e).object;j={data:null,id:null,type:d.itemType,branch:1};j.data=e;j.data.name=a;j.data.editor={group:b,type:d.itemType,origin:b};d.project.setItem(j,function(a){d.nameBuffer[a[0].name]=a[0];c&&c()},!1)})},__class__:G};var q=function(a,b){null==b&&(b=!1);this.respawnServer=!0;this.needRedeploy=this.deployInProgress=!1;this.startServerRetries=0;this.broken=!1;this.port=0;
this.removing=!1;var c=this;d.debug("Opening project:",a);q.loaded.push(this);0==q.nextPort&&(q.nextPort=d.cfg.port);this.deployCbs=[];this.name=a;this.path=d.path.normalize(i.string(d.cfg.projectPath)+"/"+this.name).split("\\").join("/");this.privatePath=this.path+"/"+i.string(d.cfg.editorPath);this.enginePath=this.path+"/"+i.string(d.cfg.enginePath);this.pluginsPaths=[];for(var f=0,e=d.cfg.pluginsPaths.length;f<e;){var g=f++;this.pluginsPaths.push(this.path+"/"+d.cfg.pluginsPaths[g].path)}this.enginePluginsPath=
this.enginePath+"/"+i.string(d.cfg.enginePluginsPath);this.addonsPaths=[];f=0;for(e=d.cfg.addonsPaths.length;f<e;)g=f++,this.addonsPaths.push(this.path+"/"+d.cfg.addonsPaths[g].path);this.Import=new Q(this.path,v(this,this.checkItems),this);this.db=new R(this.privatePath+"/DB.json");this.enginePlugins=new G(this,d.cfg.pluginType,"Cfg",this.enginePluginsPath,"Core");var h="";this.plugins=[];f=0;for(e=this.pluginsPaths.length;f<e;)g=f++,h=d.cfg.addonsPaths[g].origin,"project"==h&&(h=this.name),this.plugins.push(new G(this,
d.cfg.pluginType,"Cfg",this.pluginsPaths[g],h));this.addons=[];f=0;for(e=this.addonsPaths.length;f<e;)g=f++,h=d.cfg.addonsPaths[g].origin,"project"==h&&(h=this.name),this.addons.push(new G(this,d.cfg.addonType,"Addon",this.addonsPaths[g],h));this.update(function(){c.watchFiles();!b&&!d.cfg.demoMode&&c.startServer();c.broken=b;c.onStopServer=d.emptyFn;c.deploy({branch:1},null)})};q.__name__=!0;q.genOtito=function(a,b){return new q.exOtito(a,b)};q.importProject=function(a,b){var c=a.split(d.path.sep).pop().split(".").shift();
d.checkAndSave(i.string(d.cfg.projectPath)+"/"+c,function(c){var e=c.split(d.path.sep).pop();d.unzip(a,c,function(){b({success:!0,file:e})})})};q.newProject=function(a,b){var c=q.getProject(a);null!=c?b(c):d.fs.exists(i.string(d.cfg.projectPath)+"/"+a,function(c){c?b(new q(a)):(d.debug("Trying to load non existent project!!!"),b(new q(a,!0)))})};q.getProject=function(a){for(var b=0,c=q.loaded;b<c.length;){var d=c[b];++b;if(d.name==a)return d}return null};q.rmProject=function(a,b){var c=q.getProject(a);
null!=c&&c.stop(b)};q.stopAll=function(){d.debug("Project::stopAll - stopping childs");for(var a=0,b=q.loaded;a<b.length;){var c=b[a];++a;c.stop(function(){d.debug("Project node stopped")})}};q.prototype={getPort:function(){return this.port},getAddonsType:function(){return this.addons[0].itemType},getPluginsType:function(){return this.plugins[0].itemType},getName:function(){return this.name},getPrivatePath:function(){return this.privatePath},getPath:function(){return this.path},getBranchName:function(a){return this.db.getBranchName(a)},
stopServer:function(a){this.respawnServer=!1;this.onStopServer=a?a:d.emptyFn;if(null!=this.gameServer)this.gameServer.kill();else this.onStopServer()},startServerReal:function(a){var b=this,a={cwd:a};try{this.gameServer=d.child.spawn("node",["server.js",""+q.nextPort],a),this.gameServer.on("exit",function(a){b.onStopServer();d.debug("Project::Gameserver -> process exited with code "+a);b.respawnServer&&(d.debug("respawning server"),m.Timer.delay(function(){b.startServer()},1E3))}),this.gameServer.stdout.on("data",
function(a){"setNextPort"==a.toString().trim()&&d.debug("is it calling now?")}),this.gameServer.stderr.on("data",function(a){d.debug("Project::Gameserver ERROR ->\r\n--------------------",a.toString().replace("\n","\n\t")+"\r\n--------------------------------------")})}catch(c){this.respawnServer=!1,d.debug("Project::startServer -> Error spawning child",c),this.emitAll("Error","Failed to spawn child!")}m.Timer.delay(function(){b.emitAll("updateGamePort",b.port)},1E3)},startServer:function(){var a=
this;d.debug("Project::StartServer:",this.startServerRetries);q.nextPort++;this.startServerRetries++;if(10<this.startServerRetries)this.emitAll("error","error_spawn_game_server::not_starting");else{this.port=q.nextPort;var b=d.path.resolve(this.path+"/server");d.debug("Project::StartServer -> starting","server.js:"+q.nextPort);d.fs.exists(b+"/server.js",function(c){c?a.startServerReal(b):(d.debug("Project::Gameserver -> server.js not found"),a.emitAll("error","error_spawn_game_server::not_found"))})}},
stop:function(a){u.remove(q.loaded,this);this.removing=!0;this.watcher&&this.watcher.stop();this.stopServer(a)},updateProjectAddons:function(a,b){var c=this;if(b==this.addons.length)a();else{d.debug("updateAddons "+b+"/"+(this.addons.length-1));var f=b+1;this.addons[b].update(function(){c.updateProjectAddons(a,f)})}},updateProjectPlugins:function(a,b){var c=this;if(b==this.plugins.length)a();else{var d=b+1;this.plugins[b].update(function(){c.updateProjectPlugins(a,d)})}},updatePlugins:function(a){var b=
this;this.enginePlugins.update(function(){b.updateProjectPlugins(function(){b.updateProjectAddons(a,0)},0)})},update:function(a){var b=this;this.Import.update(function(){b.Import.errorInConfig?d.debug("error in config.. skipping rest checks..."):b.updatePlugins(function(){b.checkItems(function(){b.deploy({branch:1},function(){a&&a()})})})})},onSourceChanged:function(a,b,c){d.debug("Watcher event...",c);this.removing||(this.emitAll("sourceChanged",a),this.update())},watchFiles:function(){var a=this;
d.fs.stat(this.path,function(b){if(null!=b)d.debug("Project::watchFiles::Stat -> FATAL ERROR",b);else try{d.debug("Watching files"),a.watcher=d.cfg.engineDevMode?new K(a.path,v(a,a.onSourceChanged)):new K(a.path+"/src",v(a,a.onSourceChanged))}catch(c){d.debug("Project::watcher -> failed",c)}});d.addWatcherCallback(v(this,this.onSourceChanged))},emitAll:function(a,b){E.emitAllStatic(a,b,this.name)},"export":function(a){var b=d.path.resolve(i.string(d.cfg.projectPath)+"/"+this.name),c=b+"/.editor/"+
this.name+"."+i.string(d.cfg.projectExtension);d.fs.exists(c,function(f){f?d.fs.unlink(c,function(){d.mkzip(c,b,a)}):(d.debug("Project::ZIP",c,b),d.mkzip(c,b,a))})},deploy:function(a,b,c){var f=this;null!=b&&this.deployCbs.push(b);this.deployInProgress?(d.debug("Project -> Deploy in progress..."),this.needRedeploy=!0,null!=b&&b()):(this.deployInProgress=!0,new P(this,a,function(b){f.deployInProgress=!1;if(f.needRedeploy)f.needRedeploy=!1,f.deploy(a,null,c);else for(;0<f.deployCbs.length;)f.deployCbs.shift()(b)},
c))},checkAllItems:function(a){var b=this,c=[];this.Import.get(function(f,e,g,h){b.Import.errorInConfig||(b.emitAll("updateImport",{Import:f,ImportDef:e}),q.exOtito.setImport(f),q.exOtito.setImportDef(h),b.db.getData(function(e){var g=Object.keys(e);u.remove(g,"__auto_inc");u.remove(g,"__branch_id");for(var i={},t=0;t<g.length;){var s=g[t];++t;for(var s=e[s].items,x=Object.keys(s),n=0;n<x.length;){var r=x[n];++n;var m=s[r].data;if(!m){d.debug("BROKEN DB!!!!!!!!!!!!!!!!!!!!!!!!",r);return}!m.editor||
!m.editor.type?d.debug("Project -> check -> List: skipping item",m):(i[m.editor.type]||(i[m.editor.type]=p.inArray(d.cfg.noEmptyValue,m.editor.type)?{}:{"0":""}),i[m.editor.type][r]=m.name)}q.exOtito.setLists(i);for(n=0;n<x.length;)r=x[n],++n,m=s[r].data,m.editor&&("Plugin"==m.editor.type?q.exTools.createPluginMeta(m,f,h):"Addon"==m.editor.type?q.exTools.createAddonMeta(m,f,h):m.editor.plugin&&q.exTools.createMeta(m,null,null,f,h))}0<c.length&&b.db.forceSave();b.emitAll("itemsChanged",c);null!=a&&
a(c)}))})},checkItems:function(a){this.checkAllItems(a)},resolveEnums:function(a,b){var c=Object.keys(a),f;f=p.isArray(a)?[]:{};for(var e=0;e<c.length;){var g=c[e];++e;var h=a[g],j=typeof h;"object"==j&&h?f[g]=this.resolveEnums(h,b):"string"!=j?f[g]=h:0!=h.indexOf(p.enumStr)?f[g]=h:(j=p.resolveEnums(h,b),null==j?d.debug("Project::resolve enums -> Cannot resolve enum!!!",h):f[g]=j)}return f},fixAllItems:function(a){for(var b=[],c=Object.keys(a),d,e=0;e<c.length;)d=c[e],++e,d=a[d],b.push(this.fixItem(d));
return b},fixItems:function(a){for(var b=[],c=0;c<a.length;){var d=a[c];++c;b.push(this.fixItem(d))}return b},fixItem:function(a){if(!a)return d.debug("fixing item NULL"),null;a.data||(d.debug("fixing item data NULL"),a.data={});a.data.editor||(d.debug("fixing item.data.editor NULL",a),a.data.editor={});a.data.id=a.id;a.data.editor.branch=a.branch;a.data.editor.type=a.type;return a.data},deleteBranch:function(a,b){this.db.deleteBranch(a);b()},setBranch:function(a,b){var c=this;this.db.setBranch(a,
function(a){c.deploy({branch:a},function(){c.getBranchesTree(1,b)})})},getBranchesTree:function(a,b){this.db.getBranchesTree(a,b)},delItemReal:function(a,b){var c=this;this.db.delItem(a.id,a.branch,function(d,e){c.checkItems();var g=c.fixItem(d),h=c.fixItems(e);b(g,h);(null==e||0==e.length)&&c.emitAll("itemDeleted",g);c.emitAll("itemsChanged",h);c.updatePlugins(function(){c.deploy({branch:a.branch},null)})})},delItem:function(a,b){this.delItemReal(a,b)},setItem:function(a,b,c){null==c&&(c=!0);var d=
this;this.db.set(a.id,a,function(e){var g=d.fixItems(e);c?d.deploy({branch:a.branch},function(){b(g);d.emitAll("itemsChanged",g)}):(d.emitAll("itemsChanged",g),b(g))})},getAllItems:function(a,b){var c=this;this.db.getAllItems(a,function(a){b(c.fixAllItems(a))})},getItems:function(a,b){var c=this;this.db.get(a.id,a.where,function(a){b(c.fixItems(a))})},getImport:function(a){this.Import.get(a)},isBroken:function(){return this.broken},__class__:q};var w=function(){};w.__name__=!0;w.hasField=function(a,
b){return Object.prototype.hasOwnProperty.call(a,b)};w.field=function(a,b){var c=null;try{c=a[b]}catch(d){}return c};w.fields=function(a){var b=[];if(null!=a){var c=Object.prototype.hasOwnProperty,d;for(d in a)"__id__"!=d&&("hx__closures__"!=d&&c.call(a,d))&&b.push(d)}return b};w.isFunction=function(a){return"function"==typeof a&&!(a.__name__||a.__ename__)};w.deleteField=function(a,b){if(!w.hasField(a,b))return!1;delete a[b];return!0};var N=function(a,b){null==b&&(b=!1);this.name=a;this.buffer=[];
this.tmpBuffer=[];this.isRunning=!1;this.debug=b};N.__name__=!0;N.prototype={release:function(){this.buffer.length=0;this.debug&&d.debug("Stack::Release",this.name);return this},runTmp:function(){this.debug&&d.debug("Stack::RunTMP",this.name,this.tmpBuffer.length);if(0==this.tmpBuffer.length)this.isRunning=!1;else{for(var a=0,b=this.tmpBuffer;a<b.length;){var c=b[a];++a;this.buffer.push(c)}this.tmpBuffer.length=0;this.isRunning=!1;this.run()}},run:function(){if(this.isRunning)return this;this.debug&&
d.debug("Stack::Run",this.name,this.buffer.length);this.isRunning=!0;for(var a=0,b=this.buffer;a<b.length;){var c=b[a];++a;c()}this.runTmp();return this},add:function(a){this.debug&&d.debug("Stack::Add",this.name,this.buffer.length);if(this.isRunning)return this.tmpBuffer.push(a),this;this.buffer.push(a);return this},__class__:N};var i=function(){};i.__name__=!0;i.string=function(a){return z.Boot.__string_rec(a,"")};i.parseInt=function(a){var b=parseInt(a,10);if(0==b&&(120==u.cca(a,1)||88==u.cca(a,
1)))b=parseInt(a);return isNaN(b)?null:b};i.parseFloat=function(a){return parseFloat(a)};var O=function(){this.b=""};O.__name__=!0;O.prototype={addSub:function(a,b,c){this.b+=null==c?u.substr(a,b,null):u.substr(a,b,c)},__class__:O};var y=function(){};y.__name__=!0;y.urlDecode=function(a){return decodeURIComponent(a.split("+").join(" "))};y.htmlEscape=function(a,b){a=a.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;");return b?a.split('"').join("&quot;").split("'").join("&#039;"):
a};y.isSpace=function(a,b){var c=u.cca(a,b);return 8<c&&14>c||32==c};y.ltrim=function(a){for(var b=a.length,c=0;c<b&&y.isSpace(a,c);)c++;return 0<c?u.substr(a,c,b-c):a};y.rtrim=function(a){for(var b=a.length,c=0;c<b&&y.isSpace(a,b-c-1);)c++;return 0<c?u.substr(a,0,b-c):a};y.trim=function(a){return y.ltrim(y.rtrim(a))};y.replace=function(a,b,c){return a.split(b).join(c)};var p=function(){};p.__name__=!0;p.clone=function(a){var b;if(!a||"object"!=typeof a)return a;if(p.isArray(a)){b=[];for(var c=0;c<
a.length;){var d=a[c];++c;"object"===typeof d&&null!=d?b.push(p.clone(d)):b.push(d)}return b}b={};d=Object.keys(a);for(c=0;c<d.length;){var e=d[c];++c;var g=a[e];b[e]="object"===typeof g&&null!=g?p.clone(g):g}return b};p.mergeObjects=function(a,b){if(null==a)return p.clone(b);if(null==b)return p.clone(a);var c=p.clone(a);if("object"!=typeof b)return c;for(var d=Object.keys(b),e=0;e<d.length;){var g=d[e];++e;var h=J["typeof"](a[g]),j=J["typeof"](b[g]);null!=h?"undefined"!=j&&(c[g]=p.mergeObjects(c[g],
p.clone(b[g]))):"undefined"==h&&(c[g]=b[g])}return c};p.getType=function(a){return typeof a};p.resolveEnums=function(a,b){var c=a.substring(p.enumStr.length);return p.resolveObject(c,b)};p.resolveObject=function(a,b){var c=a.split(".");c.shift();for(var f=b,e=0;e<c.length;){var g=c[e];++e;f=f[g];if(null==f){d.debug("Tools::resolveObject Cannot resolve",a);break}}return f};p.inArray=function(a,b){for(var c=0;c<a.length;){var d=a[c];++c;if(d==b)return!0}return!1};p.splitInLines=function(a){return a.split("\r\n").join("\n").split("\r").join("\n").split("\n")};
p.isArray=function(a){return Array.isArray(a)};p.getTime=function(){return Date.now()};p.shellEscape=function(a){return a};var n={__ename__:!0,__constructs__:"TNull TInt TFloat TBool TObject TFunction TClass TEnum TUnknown".split(" "),TNull:["TNull",0]};n.TNull.toString=D;n.TNull.__enum__=n;n.TInt=["TInt",1];n.TInt.toString=D;n.TInt.__enum__=n;n.TFloat=["TFloat",2];n.TFloat.toString=D;n.TFloat.__enum__=n;n.TBool=["TBool",3];n.TBool.toString=D;n.TBool.__enum__=n;n.TObject=["TObject",4];n.TObject.toString=
D;n.TObject.__enum__=n;n.TFunction=["TFunction",5];n.TFunction.toString=D;n.TFunction.__enum__=n;n.TClass=function(a){a=["TClass",6,a];a.__enum__=n;a.toString=D;return a};n.TEnum=function(a){a=["TEnum",7,a];a.__enum__=n;a.toString=D;return a};n.TUnknown=["TUnknown",8];n.TUnknown.toString=D;n.TUnknown.__enum__=n;var J=function(){};J.__name__=!0;J["typeof"]=function(a){switch(typeof a){case "boolean":return n.TBool;case "string":return n.TClass(String);case "number":return Math.ceil(a)==a%2147483648?
n.TInt:n.TFloat;case "object":if(null==a)return n.TNull;var b=a.__enum__;if(null!=b)return n.TEnum(b);a=a.__class__;return null!=a?n.TClass(a):n.TObject;case "function":return a.__name__||a.__ename__?n.TObject:n.TFunction;case "undefined":return n.TNull;default:return n.TUnknown}};J.enumIndex=function(a){return a[1]};var F=function(a,b,c,d){this.project=a;this.editor=d;this.callback=c;this.data=b};F.__name__=!0;F.prototype={removeFile:function(){try{d.fs.unlinkSync(this.project.getPath()+"/"+i.string(this.data.path))}catch(a){}this.callback()},
deleteUITemplate:function(){this.name=this.normalizeName(this.data.name);var a=this.project.getPath()+"/"+this.getTemplatePath();if(d.fs.existsSync(a)){try{d.fs.unlinkSync(a+"/base.css")}catch(b){}try{d.fs.unlinkSync(a+"/base.js")}catch(c){}try{d.fs.unlinkSync(a+"/index.html")}catch(f){}try{d.fs.unlinkSync(a+"/"+this.name+".html")}catch(e){}var g=a+"/"+this.name+".css";if(d.fs.existsSync(g)){var h=new String(d.fs.readFileSync(g));h==this.getCustomCSS()&&d.fs.unlinkSync(g)}g=a+"/"+this.name+".js";
d.fs.existsSync(g)&&(h=new String(d.fs.readFileSync(g)),h==this.getCustomJS()&&d.fs.unlinkSync(g));try{d.fs.rmdirSync(a+"/img")}catch(j){}try{d.fs.rmdirSync(a)}catch(i){}}this.callback()},listSubtemplates:function(){var a=[],b=null,b=function(c){for(var d=0,e=c.length;d<e;){var g=d++,g=c[g];if(null!=g.options._subtemplate){for(var h=!1,j=0;j<a.length;){var i=a[j];++j;if(i==g.options._subtemplate){h=!0;break}}h||a.push(g.options._subtemplate)}"panel"==g.type&&b(g.children)}};b(this.data.objects);return a},
getCSSProperties:function(a){for(var b=[],c=0,d=w.fields(a);c<d.length;){var e=d[c];++c;var g=""+i.string(w.field(a,e));0!=g.length&&b.push(e+": "+g)}return b.join("; ")},getAttribs:function(a){for(var b=[],c=0,d=w.fields(a);c<d.length;){var e=d[c];++c;var g=""+i.string(w.field(a,e));0!=g.length&&b.push(" "+e+'="'+y.htmlEscape(g,!0)+'"')}return b.join("")},getIndent:function(a){for(var b="",c=0;c<a;)c++,b+="  ";return b},getCustomJS:function(){return'\n"use strict";\n\nmighty.TemplateJS["'+this.name+
'"] = function()\n{\n  this.onShow = function() {\n    \n  }\n};\n'},getBaseJS:function(){var a="// This is script-generated JS. Don't change! Any changes will be lost on next template save.\n\n";this.data.normal_name=this.name;var b=[],c=null,c=function(a,b){for(var d=0;d<a.length;){var e=a[d];++d;if("panel"==e.type){var f={id:e.id,is_first:e.is_first,align:e.options.align,anchor_align:e.options.anchor_align,children:[],css:{},height:e.options.height};null!=e.left&&(f.left=e.left);null!=e.right&&
(f.right=e.right);null!=e.top&&(f.top=e.top);null!=e.bottom&&(f.bottom=e.bottom);for(var g=["position","left","right","top","bottom"],h=0;h<g.length;){var i=g[h];++h;var l=w.field(e.options.css,i);null!=l&&(f.css[i]=l)}"auto"==e.options.width&&(f.auto_width=!0);"auto"==e.options.height&&(f.auto_height=!0);g=!0;h=0;for(i=z.Boot.__cast(e.children,Array);h<i.length;)if(l=i[h],++h,"panel"!=l.type){g=!1;break}f.ch_all_panels=g;b.push(f);c(e.children,f.children)}}};c(this.data.objects,b);this.data.objects=
b;for(var a=a+'"use strict";\n\nvar mighty = mighty || {};\n\n',a=a+"mighty.templatebase = mighty.templatebase || {};\n\n",a=a+"mighty.TemplateJS = mighty.TemplateJS || {};\n\n",a=a+('mighty.templatebase["'+this.name+'"] = function(){\n\n'),a=a+("  var data = "+m.Json.stringify(this.data)+";\n\n"),a=a+i.string(d.fs.readFileSync("../client/js/plugins/ui/base_part.js")),a=a+"};\n\n\n",b=this.project.getPath(),f=0,e=this.subtemplates;f<e.length;){var g=e[f];++f;var h=b+"/src/widgets/"+g+"/"+g+".js";
d.fs.existsSync(h)&&(a+="/* file: widgets/"+g+"/"+g+".js:  */\n"+i.string(d.fs.readFileSync(h)))}return a},getCustomCSS:function(){return"/* Here you can write customized CSS. Classes and IDs should be prefixed with template name, e.g.: .mytemplate-form */\n\n"},setCSS:function(a,b){for(var c=0,d=w.fields(b);c<d.length;){var e=d[c];++c;a[e]=w.field(b,e)}},getBaseCSS:function(){var a=this,b;b="/* This is script-generated CSS. Don't change! Any changes will be lost on next template save. */\n\n"+("."+
this.name+"-panel { position: absolute; }\n");b+="."+this.name+"-panel > .wrap { \n  position: absolute;\n  left: 0;\n  top: 0;\n  right: 0;\n  bottom: 0;\n  overflow: auto;\t\t\n\t\t }\n\t\t \n\t\t ."+this.name+"-panel > .wrap.static {\n  position: relative;\n  left: auto;\n  top: auto;\n  right: auto;\n  bottom: auto;\n\t\t }\n";this.data.hide_custom_css&&(b+="."+this.name+"-panel > .wrap { \n  border: 1px solid black; \n\t\t\t}\n");b+="."+this.name+"-template { position: relative; width: 100%; height: 100%; }\n";
b+="."+this.name+"-template * { font-family: Arial, sans-serif; font-size: 14px; color: white; }\n";b+="."+this.name+"-template button { color: inherit; font: inherit; }\n\n";b+="."+this.name+"-template button {\n\tdisplay: inline-block;\n\tmin-width: 50px;\n\tpadding: 5px 10px;\n\tmargin: 0 9px 6px 0;\n\tfont-family: arial, sans-serif;\n\tfont-size: 13px;\n\ttext-align: center;\n\tcursor: pointer;\n\t\n\tborder: 1px solid rgba(0,0,0,0.4);\n\tborder-radius: 3px;\n\tbox-shadow: 0 1px 0 rgba(255,255,255,0.1) inset;\n\t\n\tbackground: #404040; /* Old browsers */\n\t/* IE9 SVG, needs conditional override of 'filter' to 'none' */\n\tbackground: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pgo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDEgMSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+CiAgPGxpbmVhckdyYWRpZW50IGlkPSJncmFkLXVjZ2ctZ2VuZXJhdGVkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzQwNDA0MCIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMzMDMwMzAiIHN0b3Atb3BhY2l0eT0iMSIvPgogIDwvbGluZWFyR3JhZGllbnQ+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgZmlsbD0idXJsKCNncmFkLXVjZ2ctZ2VuZXJhdGVkKSIgLz4KPC9zdmc+);\n\tbackground: -moz-linear-gradient(top,  #404040 0%, #303030 100%); /* FF3.6+ */\n\tbackground: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#404040), color-stop(100%,#303030)); /* Chrome,Safari4+ */\n\tbackground: -webkit-linear-gradient(top,  #404040 0%,#303030 100%); /* Chrome10+,Safari5.1+ */\n\tbackground: -o-linear-gradient(top,  #404040 0%,#303030 100%); /* Opera 11.10+ */\n\tbackground: -ms-linear-gradient(top,  #404040 0%,#303030 100%); /* IE10+ */\n\tbackground: linear-gradient(to bottom,  #404040 0%,#303030 100%); /* W3C */\n\tfilter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#404040', endColorstr='#303030',GradientType=0 ); /* IE6-8 */\n}\n."+
this.name+"-template button:hover {\n\tbox-shadow: 0 1px 0 rgba(0,0,0,0.2) inset;\n\t\n\tbackground: #303030; /* Old browsers */\n\t/* IE9 SVG, needs conditional override of 'filter' to 'none' */\n\tbackground: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pgo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDEgMSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+CiAgPGxpbmVhckdyYWRpZW50IGlkPSJncmFkLXVjZ2ctZ2VuZXJhdGVkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzMwMzAzMCIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMyMDIwMjAiIHN0b3Atb3BhY2l0eT0iMSIvPgogIDwvbGluZWFyR3JhZGllbnQ+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgZmlsbD0idXJsKCNncmFkLXVjZ2ctZ2VuZXJhdGVkKSIgLz4KPC9zdmc+);\n\tbackground: -moz-linear-gradient(top,  #303030 0%, #202020 100%); /* FF3.6+ */\n\tbackground: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#303030), color-stop(100%,#202020)); /* Chrome,Safari4+ */\n\tbackground: -webkit-linear-gradient(top,  #303030 0%,#202020 100%); /* Chrome10+,Safari5.1+ */\n\tbackground: -o-linear-gradient(top,  #303030 0%,#202020 100%); /* Opera 11.10+ */\n\tbackground: -ms-linear-gradient(top,  #303030 0%,#202020 100%); /* IE10+ */\n\tbackground: linear-gradient(to bottom,  #303030 0%,#202020 100%); /* W3C */\n\tfilter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#303030', endColorstr='#202020',GradientType=0 ); /* IE6-8 */\n}\n\t\t\n\t\t";
var c=null,c=function(b){for(var d="",e=0,f=b.length;e<f;){var g=e++,g=b[g],h="."+a.name+"-"+g.id;switch(g.type){case "panel":var i={};""!=g.options.width&&(i.width="auto"==g.options.width?"auto":g.options.width+g.options.width_units);""!=g.options.height&&(i.height="auto"==g.options.height?"auto":g.options.height+g.options.height_units);""!=g.options.bg_image&&(i["background-image"]='url("'+g.options.bg_image+'")',i["background-repeat"]="no-repeat");a.setCSS(i,g.options.css);d+=h+" { "+a.getCSSProperties(i)+
" }\n";i={};"auto"==g.options.width&&(i["overflow-x"]="hidden");"auto"==g.options.height&&(i["overflow-y"]="hidden");0<w.fields(i).length&&(d+=h+" > .wrap { "+a.getCSSProperties(i)+" }\n");d+=c(g.children);break;case "label":i={};""!=g.options.align&&(i["text-align"]=g.options.align);a.setCSS(i,g.options.css);d+=h+" { "+a.getCSSProperties(i)+" }\n";break;case "button":i={},a.setCSS(i,g.options.css),d+=h+" { "+a.getCSSProperties(i)+" }\n"}}return d};b+=c(this.data.objects)+"\n\n";for(var f=this.project.getPath(),
e=0,g=this.subtemplates;e<g.length;){var h=g[e];++e;var j=f+"/src/widgets/"+h+"/"+h+".css";d.fs.existsSync(j)&&(b+="/* file: widgets/"+h+"/"+h+".css:  */\n"+i.string(d.fs.readFileSync(j)))}return b},getFullHTML:function(){var a;a="<!DOCTYPE html>\n<html>\n<head>\n  <meta charset='utf-8'>\n  <\!-- This is script-generated HTML. Don't change! Any changes will be lost on next template save. --\>\n";a+="  <title>"+i.string(this.data.name)+"</title>\n";a+="  <style type='text/css'>\n";a+="    html { height: 100%; }\n";
a+="    body { height: 100%; margin: 0; padding: 0; }\n";a+="  </style>\n";a+='  <link rel="stylesheet" href="base.css" type="text/css" media="all" />\n';if(null==this.data.hide_custom_css||!this.data.hide_custom_css)a+='  <link rel="stylesheet" href="'+this.name+'.css" type="text/css" media="all" />\n';a+='  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"><\/script>\n';a+='  <script type="text/javascript" src="../../../../engine/library/class.js"><\/script>\n';a+='  <script type="text/javascript" src="/engine/plugins/Template/PanelWidget.js"><\/script>\n';
a+="</head>\n<body style='background:white'>\n";var b=this.getMainHTMLInfo();a+=b.html;a+='  <script type="text/javascript" src="base.js"><\/script>\n';a+='  <script type="text/javascript" src="'+this.name+'.js"><\/script>\n';a+="\n\t\t\t<script>\n\t\t\t\t$(function(){\n\t\t\t\t\tmighty.templatebase['"+this.name+"']();\n\t\t\t\t\t//new mighty.TemplateJS['"+this.name+"']().onShow();\n\t\t\t\t});\n\t\t\t<\/script>\n\t\t";return a+="</body>\n</html"},normalizeName:function(a){return y.replace(a," ",
"_")},getMainHTMLInfo:function(){var a=this,b="  <div class='"+this.name+"-template'>\n",c=function(b){var c={},d=w.field(b.options,"class");null==d&&(d="");d=d.split(" ");"panel"==b.type&&d.push(a.name+"-panel");d.push(a.name+"-"+i.string(b.id));null!=b.options.id&&0<b.options.id.length&&(c.id=b.options.id);c["class"]=d.join(" ");null!=b.options.data_var&&0<b.options.data_var.length&&(c["data-var"]=b.options.data_var);null!=b.options.data_click&&0<b.options.data_click.length&&(c["data-click"]=b.options.data_click);
return c},d=null,d=function(b,g){for(var h="",i=0,m=b.length;i<m;){var k=i++,k=b[k];switch(k.type){case "panel":for(var n=c(k),s="auto"==k.options.width||"auto"==k.options.height,q=0,p=k.children,r=0,u=p.length;r<u;){var v=r++;"panel"==p[v].type&&q++}q==p.length&&(s=!1);h+=a.getIndent(g)+"<div"+a.getAttribs(n)+"><div class='wrap"+(s?" static":"")+"'>\n";h+=d(k.children,g+1);h+=a.getIndent(g)+"</div></div>\n";break;case "label":n=c(k);h+=a.getIndent(g)+"<div"+a.getAttribs(n)+">"+y.replace(y.htmlEscape(k.options.text),
"\n","<br/>")+"</div>\n";break;case "button":n=c(k),h+=a.getIndent(g)+"<button"+a.getAttribs(n)+">"+y.htmlEscape(k.options.label)+"</button>\n"}}return h},b=b+d(this.data.objects,2);return{html:b+"  </div>\n"}},getTemplatePath:function(){var a="widget"==this.data.type?"src/widgets":"src/templates";return a+="/"+this.name},generateHtml:function(){var a=this,b=d.require("wrench");this.templates_path="widget"==this.data.type?"src/widgets":"src/templates";var c=this.project.getPath();this.name=this.normalizeName(this.data.name);
if(!this.data.use_tmp_folder&&null!=this.data.old_item&&(this.data.type!=this.data.old_item.type||this.name!=this.data.old_item.normal_name)){var f=this.data.old_item.normal_name,e=c+"/"+("widget"==this.data.old_item.type?"src/widgets":"src/templates")+"/"+f,g=c+"/"+this.templates_path+"/"+this.name;if(e!=g&&d.fs.existsSync(e)){d.fs.renameSync(e,g);try{var i=g+"/"+this.name+".js";d.fs.unlinkSync(g+"/"+f+".html");d.fs.renameSync(g+"/"+f+".js",i);d.fs.renameSync(g+"/"+f+".css",g+"/"+this.name+".css");
var j=(new String(d.fs.readFileSync(i))).split("\n");y.trim(j[3])=='mighty.TemplateJS["'+f+'"] = function()'&&(j[3]='mighty.TemplateJS["'+this.name+'"] = function()',d.fs.writeFileSync(i,j.join("\n")))}catch(n){}}}d.fs.existsSync(c+"/"+this.templates_path)||d.fs.mkdirSync(c+"/"+this.templates_path);this.folder=this.data.use_tmp_folder?".editor":this.name;this.tpl_path=this.templates_path+"/"+this.folder;var k=this.tpl_path+"/index.html",m=this.getMainHTMLInfo(),p=this.tpl_path+"/"+this.folder+".html",
f=m.html;this.subtemplates=this.listSubtemplates();this.data.use_tmp_folder&&b.rmdirSyncRecursive(c+"/"+this.tpl_path,!0);d.fs.existsSync(c+"/"+this.tpl_path)||d.fs.mkdirSync(c+"/"+this.tpl_path);d.fs.writeFileSync(c+"/"+p,"  <\!-- This is script-generated HTML. Don't change! Any changes will be lost on next template save. --\>\n\n"+f);b=function(){d.fs.writeFileSync(c+"/"+k,a.getFullHTML());d.fs.writeFileSync(c+"/"+a.tpl_path+"/base.css",a.getBaseCSS());d.fs.writeFileSync(c+"/"+a.tpl_path+"/base.js",
a.getBaseJS());var b=c+"/"+a.tpl_path+"/"+a.name+".css";d.fs.existsSync(b)||d.fs.writeFileSync(b,a.getCustomCSS());b=c+"/"+a.tpl_path+"/"+a.name+".js";d.fs.existsSync(b)||d.fs.writeFileSync(b,a.getCustomJS());w.deleteField(m,"html");m.html_path=p;a.callback({normal_name:a.name,html_path:k,html_info:m})};f=c+"/"+this.templates_path+"/"+this.name;this.data.use_tmp_folder&&d.fs.existsSync(f)?h.copy(f,c+"/"+this.tpl_path,b):b()},__class__:F};var B=function(a,b){var c=d.getUrlParams(a.url);if(null==c.action)b.end(),
d.debug("upload without an action",c);else{var f=B.actions[c.action];if(null==f)b.end(),d.debug("Uploader: unknown action",c);else{d.debug("Upload action",c.action);var e=f.start(c)+c.qqfile,g=d.cfg.tmpPath+d.path.sep+d.mkTempName(c.qqfile),i=d.fs.createWriteStream(d.path.resolve(g));i.on("error",function(){d.debug("Uploader::WS - could not open writestream.",d.path.resolve(g))});i.on("close",function(){d.checkAndSave(e,function(a){d.debug("UPLOAD",a);h.copy(g,a,function(){b.writeHead(200,"OK",{"Content-Type":"text/html"});
d.debug("UPLOAD DONE",a);f.finish(a,b)})})});a.on("data",function(a){i.write(a)});a.on("end",function(){i.end()})}}};B.__name__=!0;B.addAction=function(a,b){B.actions[a]=b};B.prototype={__class__:B};var m={Json:function(){}};m.Json.__name__=!0;m.Json.parse=function(a){return(new m.Json).doParse(a)};m.Json.stringify=function(a,b){return(new m.Json).toString(a,b)};m.Json.prototype={parseNumber:function(a){for(var b=this.pos-1,c=45==a,d=!c,e=48==a,g=!1,h=!1,j=!1,m=!1;;){a=this.str.charCodeAt(this.pos++);
switch(a){case 48:e&&!g&&this.invalidNumber(b);c&&(c=!1,e=!0);d=!0;break;case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:e&&!g&&this.invalidNumber(b);c&&(c=!1);d=!0;e=!1;break;case 46:(c||g)&&this.invalidNumber(b);d=!1;g=!0;break;case 101:case 69:(c||e||h)&&this.invalidNumber(b);d=!1;h=!0;break;case 43:case 45:(!h||j)&&this.invalidNumber(b);d=!1;j=!0;break;default:d||this.invalidNumber(b),this.pos--,m=!0}if(m)break}a=i.parseFloat(u.substr(this.str,b,this.pos-b));b=a|0;return b==
a?b:a},invalidNumber:function(a){throw"Invalid number at position "+a+": "+u.substr(this.str,a,this.pos-a);},parseString:function(){for(var a=this.pos,b=new O;;){var c=this.str.charCodeAt(this.pos++);if(34==c)break;if(92==c){b.addSub(this.str,a,this.pos-a-1);c=this.str.charCodeAt(this.pos++);switch(c){case 114:b.b+="\r";break;case 110:b.b+="\n";break;case 116:b.b+="\t";break;case 98:b.b+="\b";break;case 102:b.b+="\f";break;case 47:case 92:case 34:b.b+=String.fromCharCode(c);break;case 117:a=i.parseInt("0x"+
u.substr(this.str,this.pos,4));this.pos+=4;b.b+=String.fromCharCode(a);break;default:throw"Invalid escape sequence \\"+String.fromCharCode(c)+" at position "+(this.pos-1);}a=this.pos}else if(c!=c)throw"Unclosed string";}b.addSub(this.str,a,this.pos-a-1);return b.b},parseRec:function(){for(;;){var a=this.str.charCodeAt(this.pos++);switch(a){case 32:case 13:case 10:case 9:break;case 123:for(var b={},c=null,a=null;;){var d=this.str.charCodeAt(this.pos++);switch(d){case 32:case 13:case 10:case 9:break;
case 125:return(null!=c||!1==a)&&this.invalidChar(),b;case 58:null==c&&this.invalidChar();b[c]=this.parseRec();c=null;a=!0;break;case 44:a?a=!1:this.invalidChar();break;case 34:a&&this.invalidChar();c=this.parseString();break;default:this.invalidChar()}}break;case 91:b=[];for(a=null;;)switch(d=this.str.charCodeAt(this.pos++),d){case 32:case 13:case 10:case 9:break;case 93:return!1==a&&this.invalidChar(),b;case 44:a?a=!1:this.invalidChar();break;default:a&&this.invalidChar(),this.pos--,b.push(this.parseRec()),
a=!0}break;case 116:a=this.pos;if(114!=this.str.charCodeAt(this.pos++)||117!=this.str.charCodeAt(this.pos++)||101!=this.str.charCodeAt(this.pos++))this.pos=a,this.invalidChar();return!0;case 102:a=this.pos;if(97!=this.str.charCodeAt(this.pos++)||108!=this.str.charCodeAt(this.pos++)||115!=this.str.charCodeAt(this.pos++)||101!=this.str.charCodeAt(this.pos++))this.pos=a,this.invalidChar();return!1;case 110:a=this.pos;if(117!=this.str.charCodeAt(this.pos++)||108!=this.str.charCodeAt(this.pos++)||108!=
this.str.charCodeAt(this.pos++))this.pos=a,this.invalidChar();return null;case 34:return this.parseString();case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:case 45:return this.parseNumber(a);default:this.invalidChar()}}},invalidChar:function(){this.pos--;throw"Invalid char "+this.str.charCodeAt(this.pos)+" at position "+this.pos;},doParse:function(a){this.str=a;this.pos=0;return this.parseRec()},quote:function(a){this.buf.b+='"';for(var b=0;;){var c=a.charCodeAt(b++);
if(c!=c)break;switch(c){case 34:this.buf.b+='\\"';break;case 92:this.buf.b+="\\\\";break;case 10:this.buf.b+="\\n";break;case 13:this.buf.b+="\\r";break;case 9:this.buf.b+="\\t";break;case 8:this.buf.b+="\\b";break;case 12:this.buf.b+="\\f";break;default:this.buf.b+=String.fromCharCode(c)}}this.buf.b+='"'},toStringRec:function(a,b){null!=this.replacer&&(b=this.replacer(a,b));var c=J["typeof"](b);switch(c[1]){case 8:this.buf.b+='"???"';break;case 4:this.objString(b);break;case 1:this.buf.b+=i.string(b);
break;case 2:this.buf.b+=i.string(Math.isFinite(b)?b:"null");break;case 5:this.buf.b+='"<fun>"';break;case 6:c=c[2];if(c==String)this.quote(b);else if(c==Array){c=b;this.buf.b+="[";var d=c.length;if(0<d){this.toStringRec(0,c[0]);for(var e=1;e<d;)this.buf.b+=",",this.toStringRec(e,c[e++])}this.buf.b+="]"}else if(c==m.ds.StringMap){c=b;d={};for(e=c.keys();e.hasNext();){var g=e.next();d[g]=c.get(g)}this.objString(d)}else this.objString(b);break;case 7:e=J.enumIndex(b);this.buf.b+=i.string(e);break;case 3:this.buf.b+=
i.string(b);break;case 0:this.buf.b+="null"}},objString:function(a){this.fieldsString(a,w.fields(a))},fieldsString:function(a,b){var c=!0;this.buf.b+="{";for(var d=0;d<b.length;){var e=b[d];++d;var g=w.field(a,e);w.isFunction(g)||(c?c=!1:this.buf.b+=",",this.quote(e),this.buf.b+=":",this.toStringRec(e,g))}this.buf.b+="}"},toString:function(a,b){this.buf=new O;this.replacer=b;this.toStringRec("",a);return this.buf.b},__class__:m.Json};m.Timer=function(a){var b=this;this.id=setInterval(function(){b.run()},
a)};m.Timer.__name__=!0;m.Timer.delay=function(a,b){var c=new m.Timer(b);c.run=function(){c.stop();a()};return c};m.Timer.prototype={run:function(){console.log("run")},stop:function(){null!=this.id&&(clearInterval(this.id),this.id=null)},__class__:m.Timer};m.ds={};m.ds.StringMap=function(){};m.ds.StringMap.__name__=!0;m.ds.StringMap.__interfaces__=[T];m.ds.StringMap.prototype={keys:function(){var a=[],b;for(b in this.h)this.h.hasOwnProperty(b)&&a.push(b.substr(1));return u.iter(a)},get:function(a){return this.h["$"+
a]},__class__:m.ds.StringMap};var z={Boot:function(){}};z.Boot.__name__=!0;z.Boot.__string_rec=function(a,b){if(null==a)return"null";if(5<=b.length)return"<...>";var c=typeof a;if("function"==c&&(a.__name__||a.__ename__))c="object";switch(c){case "object":if(a instanceof Array){if(a.__enum__){if(2==a.length)return a[0];for(var c=a[0]+"(",b=b+"\t",d=2,e=a.length;d<e;)var g=d++,c=2!=g?c+(","+z.Boot.__string_rec(a[g],b)):c+z.Boot.__string_rec(a[g],b);return c+")"}d=a.length;c="[";b+="\t";for(e=0;e<d;)g=
e++,c+=(0<g?",":"")+z.Boot.__string_rec(a[g],b);return c+"]"}try{e=a.toString}catch(h){return"???"}if(null!=e&&e!=Object.toString&&(c=a.toString(),"[object Object]"!=c))return c;e=null;c="{\n";b+="\t";d=null!=a.hasOwnProperty;for(e in a)if(!d||a.hasOwnProperty(e))"prototype"==e||("__class__"==e||"__super__"==e||"__interfaces__"==e||"__properties__"==e)||(2!=c.length&&(c+=", \n"),c+=b+e+" : "+z.Boot.__string_rec(a[e],b));b=b.substring(1);return c+="\n"+b+"}";case "function":return"<function>";case "string":return a;
default:return String(a)}};z.Boot.__interfLoop=function(a,b){if(null==a)return!1;if(a==b)return!0;var c=a.__interfaces__;if(null!=c)for(var d=0,e=c.length;d<e;){var g=d++,g=c[g];if(g==b||z.Boot.__interfLoop(g,b))return!0}return z.Boot.__interfLoop(a.__super__,b)};z.Boot.__instanceof=function(a,b){if(null==b)return!1;switch(b){case X:return(a|0)===a;case U:return"number"==typeof a;case V:return"boolean"==typeof a;case String:return"string"==typeof a;case Y:return!0;default:if(null!=a){if("function"==
typeof b){if(a instanceof b)return b==Array?null==a.__enum__:!0;if(z.Boot.__interfLoop(a.__class__,b))return!0}}else return!1;return b==Z&&null!=a.__name__||b==$&&null!=a.__ename__?!0:a.__enum__==b}};z.Boot.__cast=function(a,b){if(z.Boot.__instanceof(a,b))return a;throw"Cannot cast "+i.string(a)+" to "+i.string(b);};var W=0;Array.prototype.indexOf&&(u.remove=function(a,b){var c=a.indexOf(b);if(-1==c)return!1;a.splice(c,1);return!0});Math.__name__=["Math"];Math.NaN=Number.NaN;Math.NEGATIVE_INFINITY=
Number.NEGATIVE_INFINITY;Math.POSITIVE_INFINITY=Number.POSITIVE_INFINITY;Math.isFinite=function(a){return isFinite(a)};Math.isNaN=function(a){return isNaN(a)};String.prototype.__class__=String;String.__name__=!0;Array.prototype.__class__=Array;Array.__name__=!0;var X={__name__:["Int"]},Y={__name__:["Dynamic"]},U=Number;U.__name__=["Float"];var V=Boolean;V.__ename__=["Bool"];var Z={__name__:["Class"]},$={};"undefined"!=typeof JSON&&(m.Json=JSON);r.errors=[];d.progs={zip:"zip"};h.queue=[];h.inProgress=
!1;G.nameReg=new A("^[a-zA-Z]+[a-zA-Z0-9]*$","");q.nextPort=0;q.loaded=[];p.enumStr="__enum__.";B.actions={};C.main()})();
